name: Apply Auto-Fix

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to apply fixes to'
        required: true
        type: number
      run_id:
        description: 'Test run ID (for downloading artifacts)'
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  apply-fix:
    runs-on: ubuntu-latest
    
    steps:
      - name: Get PR details
        id: pr
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_DATA=$(gh pr view ${{ github.event.inputs.pr_number }} --json headRefName,headRepository --repo ${{ github.repository }})
          BRANCH=$(echo "$PR_DATA" | jq -r '.headRefName')
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT
      
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.pr.outputs.branch }}
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Download fix suggestions
        uses: actions/download-artifact@v4
        with:
          name: fix-suggestions
          run-id: ${{ github.event.inputs.run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install google-generativeai
      
      - name: Apply fixes
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          python3 .github/scripts/apply_fixes.py
      
      - name: Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          if git diff --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          
          git add index.html
          git commit -m "fix: apply AI-generated fixes"
          git push
      
      - name: Wait for PR update
        run: |
          echo "Waiting for PR to update..."
          sleep 5
      
      - name: Comment on PR
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cat > pr_comment.txt <<'EOF'
          ✅ AI修正を適用しました。テストを再実行しています...
          
          修正内容を確認してください。テストが完了するまでお待ちください。
          EOF
          
          gh pr comment ${{ github.event.inputs.pr_number }} --body-file pr_comment.txt
