<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="version" content="1.1.18">
    <!-- ‰øÆÊ≠£Ââç: <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"> -->
    <!-- ‰øÆÊ≠£Âæå: -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>ÁÖ©ÊÇ©ÈÄÄÊï£„Äú‰øÆË°åÂÉß„ÅÆËëõËó§„Äú</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            font-family: 'MS Gothic', 'Courier New', monospace;
            color: #fff;
            overflow: hidden;
            touch-action: none;
        }

        #gameContainer {
            position: relative;
            text-align: center;
            width: 100%;
            max-width: 480px;
            height: 100vh;
            max-height: 640px;
        }

        canvas {
            border: 3px solid #d4af37;
            background: linear-gradient(180deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            box-shadow: 0 0 30px rgba(212, 175, 55, 0.5);
            display: block;
            margin: 0 auto;
            width: 100%;
            height: auto;
            max-width: 480px;
        }

        .mobile-mode #gameContainer {
            max-width: 100vw;
            max-height: 100vh;
        }

        .mobile-mode canvas {
            border-width: 2px;
        }

        #info {
            margin-top: 5px;
            font-size: 16px;
            color: #d4af37;
            text-shadow: 0 0 10px rgba(212, 175, 55, 0.8);
            margin-bottom: 10px;
        }

        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            background: rgba(0, 0, 0, 0.95);
            z-index: 10;
            overflow-y: auto;
            padding: 30px 20px;
        }

        #levelScreen {
            overflow-x: hidden;
        }

        .mobile-mode .screen {
            padding: 20px 10px;
        }

        .hidden {
            display: none !important;
        }

        h1 {
            color: #d4af37;
            font-size: 40px;
            margin-top: 0;
            margin-bottom: 5px;
            text-shadow: 0 0 20px rgba(212, 175, 55, 1);
            animation: glow 2s ease-in-out infinite;
        }

        #levelScreen h1 {
            font-size: clamp(32px, 8vw, 40px);
        }

        .mobile-mode h1 {
            font-size: 24px;
        }

        @keyframes glow {

            0%,
            100% {
                text-shadow: 0 0 20px rgba(212, 175, 55, 1);
            }

            50% {
                text-shadow: 0 0 40px rgba(212, 175, 55, 1), 0 0 60px rgba(212, 175, 55, 0.8);
            }
        }

        h2 {
            color: #ff9800;
            font-size: 20px;
            margin-top: 0;
            margin-bottom: 20px;
            text-shadow: 0 0 10px rgba(255, 152, 0, 0.8);
        }

        .mobile-mode h2 {
            font-size: 14px;
            margin-bottom: 15px;
        }

        button {
            background: linear-gradient(135deg, #d4af37 0%, #aa8c2e 100%);
            border: none;
            color: #1a1a2e;
            padding: 12px 40px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            border-radius: 5px;
            margin: 8px;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(212, 175, 55, 0.4);
            min-height: 45px;
            min-width: 200px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 20px rgba(212, 175, 55, 0.6);
        }

        button:active {
            transform: translateY(0);
            box-shadow: 0 3px 10px rgba(212, 175, 55, 0.4);
        }

        .title-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
            max-width: 420px;
            margin: 0 auto;
        }

        .title-buttons button {
            margin: 0;
        }

        .mobile-mode button {
            font-size: 14px;
            padding: 10px 30px;
            min-width: 160px;
        }

        p {
            margin: 8px 0;
            line-height: 1.5;
            font-size: 13px;
        }

        .instruction {
            background: rgba(212, 175, 55, 0.1);
            border: 2px solid #d4af37;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            max-width: 400px;
        }

        .instruction p {
            color: #ffd700;
        }

        #rankingList {
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid #d4af37;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            max-width: 500px;
            width: 100%;
        }

        .rank-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 20px;
            margin: 8px 0;
            background: linear-gradient(90deg, rgba(212, 175, 55, 0.2), rgba(212, 175, 55, 0.05));
            border-radius: 5px;
            border-left: 4px solid #d4af37;
        }

        .rank-item.top3 {
            background: linear-gradient(90deg, rgba(255, 215, 0, 0.3), rgba(212, 175, 55, 0.1));
            border-left: 4px solid #ffd700;
        }

        .rank-number {
            color: #d4af37;
            font-weight: bold;
            font-size: 18px;
            min-width: 40px;
        }

        .rank-score {
            color: #fff;
            font-size: 16px;
        }

        .rank-date {
            color: #888;
            font-size: 14px;
        }

        .title-logo {
            font-size: 56px;
            margin-bottom: 20px;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        .subtitle {
            font-size: 18px;
            color: #ff6f00;
            margin-top: -15px;
            margin-bottom: 30px;
        }

        /* Title Intro */
        #titleScreen {
            overflow: hidden;
            padding: 0;
        }

        #titleMainContent {
            position: relative;
            z-index: 30;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            height: 100%;
            padding: 30px 20px;
            box-sizing: border-box;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s ease;
        }

        #titleMainContent.intro-visible {
            opacity: 1;
            pointer-events: auto;
        }

        #titleIntroOverlay {
            position: absolute;
            inset: 0;
            z-index: 40;
            pointer-events: auto;
        }

        #titleIntroOverlay.intro-fadeout {
            opacity: 0;
            transition: opacity 0.22s ease;
        }

        .intro-black {
            position: absolute;
            inset: 0;
            background: #000;
        }

        .intro-monk {
            position: absolute;
            bottom: 0;
            width: 112px;
            opacity: 0;
            filter: drop-shadow(0 0 10px rgba(255, 215, 120, 0.35));
            transform: translateY(30px) scale(0.92);
        }

        .intro-happy {
            left: 14px;
        }

        .intro-sad {
            right: 14px;
        }

        .intro-pray {
            left: 50%;
            transform: translateX(-50%) translateY(34px) scale(0.9);
        }

        .intro-happy.intro-active {
            animation: introHappyIn 0.45s ease-out forwards;
        }

        .intro-sad.intro-active {
            animation: introSadIn 0.45s ease-out forwards;
        }

        .intro-pray.intro-active {
            animation: introPrayIn 0.5s ease-out forwards;
        }

        @keyframes introHappyIn {
            from {
                opacity: 0;
                transform: translate(-18px, 34px) scale(0.88);
            }

            to {
                opacity: 1;
                transform: translate(0, 0) scale(1);
            }
        }

        @keyframes introSadIn {
            from {
                opacity: 0;
                transform: translate(18px, 34px) scale(0.88);
            }

            to {
                opacity: 1;
                transform: translate(0, 0) scale(1);
            }
        }

        @keyframes introPrayIn {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(36px) scale(0.86);
            }

            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0) scale(1);
            }
        }

        #titlePersistentPray {
            position: absolute;
            left: 50%;
            bottom: 0;
            transform: translateX(-50%);
            z-index: 20;
            opacity: 0;
            transition: opacity 0.25s ease;
            pointer-events: none;
        }

        #titlePersistentPray img {
            width: 112px;
            display: block;
            filter: drop-shadow(0 0 10px rgba(255, 215, 120, 0.35));
        }

        #titlePersistentPray.visible {
            opacity: 1;
        }

        .mobile-mode .intro-monk,
        .mobile-mode #titlePersistentPray img {
            width: 90px;
        }

        .mobile-mode #titleMainContent {
            padding: 20px 10px;
        }

        .mobile-mode .intro-happy {
            left: 8px;
        }

        .mobile-mode .intro-sad {
            right: 8px;
        }

        #currentScore {
            font-size: 28px;
            color: #ffd700;
            margin: 20px 0;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
        }

        .level-buttons {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 15px;
            margin: 20px 0;
            width: 100%;
            max-width: 420px;
            justify-items: stretch;
        }

        .level-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 18px 12px;
            min-height: 100px;
            justify-content: center;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border: 2px solid #d4af37;
            border-radius: 10px;
            color: #fff;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
            transition: all 0.3s ease;
            margin: 0;
            min-width: 0;
            width: 100%;
        }

        .level-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(212, 175, 55, 0.4);
            border-color: #ffd700;
        }

        .level-name {
            font-size: 20px;
            margin-bottom: 5px;
            color: #d4af37;
            font-weight: bold;
        }

        .level-desc {
            font-size: 13px;
            opacity: 0.8;
            color: #ccc;
        }

        .level-lock {
            font-size: 12px;
            opacity: 0.6;
            margin-top: 5px;
            color: #888;
        }

        .level-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            filter: grayscale(100%);
            border-color: #555;
        }

        .level-btn:disabled:hover {
            transform: none;
            box-shadow: none;
        }

        #levelDemon {
            grid-column: 2;
            grid-row: 2;
            background: linear-gradient(135deg, #2c0e37 0%, #1a0520 100%);
            border-color: #9c27b0;
            animation: demonPulse 2s ease-in-out infinite;
        }

        #levelDemon .level-name {
            color: #e040fb;
        }

        #levelDemon:hover {
            box-shadow: 0 0 20px rgba(156, 39, 176, 0.6);
            border-color: #e040fb;
        }



        #levelDemon.hidden {
            display: none !important;
        }

        @keyframes demonPulse {

            0%,
            100% {
                box-shadow: 0 5px 15px rgba(156, 39, 176, 0.4);
            }

            50% {
                box-shadow: 0 5px 25px rgba(156, 39, 176, 0.8), 0 0 30px rgba(156, 39, 176, 0.5);
            }
        }

        /* „Éë„Çπ„ÉØ„Éº„ÉâÂÖ•Âäõ„É¢„Éº„ÉÄ„É´ */
        #passwordModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        .password-container {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border: 3px solid #d4af37;
            border-radius: 15px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 0 40px rgba(212, 175, 55, 0.6);
        }

        .password-container h2 {
            color: #d4af37;
            margin-bottom: 20px;
            text-align: center;
        }

        .password-container p {
            color: #ffd700;
            margin-bottom: 15px;
            text-align: center;
            font-size: 14px;
            line-height: 1.6;
        }

        .password-hint {
            color: #888;
            font-size: 12px;
            margin-top: 5px;
        }

        #passwordInput {
            width: 100%;
            padding: 12px;
            font-size: 18px;
            border: 2px solid #d4af37;
            border-radius: 5px;
            background: rgba(0, 0, 0, 0.5);
            color: #fff;
            text-align: center;
            font-family: 'MS Gothic', 'Courier New', monospace;
            margin-bottom: 20px;
        }

        #passwordInput:focus {
            outline: none;
            border-color: #ffd700;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .password-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .password-buttons button {
            min-width: 120px;
        }

        #passwordMessage {
            text-align: center;
            margin-top: 15px;
            font-size: 14px;
            min-height: 20px;
        }

        #passwordMessage.success {
            color: #00ff88;
        }

        #passwordMessage.error {
            color: #ff6f00;
        }

        .unlock-btn {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border: 2px solid #4caf50;
            color: #4caf50;
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.2);
            font-size: 16px;
            padding: 10px 30px;
            min-width: 180px;
            margin-top: 20px;
            border-radius: 25px;
            transition: all 0.3s ease;
        }

        .unlock-btn:hover {
            background: #4caf50;
            color: #fff;
            box-shadow: 0 0 20px rgba(76, 175, 80, 0.6);
        }

        /* Settings Modal */
        #settingsModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 200;
        }

        .settings-container {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border: 3px solid #d4af37;
            border-radius: 15px;
            padding: 30px;
            max-width: 450px;
            width: 90%;
            box-shadow: 0 0 50px rgba(212, 175, 55, 0.6);
            text-align: center;
        }

        .settings-container h2 {
            font-size: 28px;
            margin-bottom: 30px;
            border-bottom: 1px solid rgba(212, 175, 55, 0.3);
            padding-bottom: 15px;
        }

        .setting-group {
            margin-bottom: 25px;
            text-align: left;
        }

        .setting-label {
            color: #d4af37;
            font-size: 18px;
            margin-bottom: 10px;
            display: block;
        }

        .toggle-options {
            display: flex;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 30px;
            padding: 5px;
            position: relative;
        }

        .toggle-btn {
            flex: 1;
            border: none;
            background: transparent;
            color: #aaa;
            padding: 10px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 25px;
            transition: all 0.3s;
            margin: 0;
            box-shadow: none;
            min-height: auto;
            min-width: auto;
        }

        .toggle-btn.active {
            background: #d4af37;
            color: #1a1a2e;
            font-weight: bold;
            box-shadow: 0 2px 10px rgba(212, 175, 55, 0.4);
        }

        .toggle-btn:hover:not(.active) {
            color: #fff;
            transform: none;
        }

        .settings-desc {
            font-size: 12px;
            color: #888;
            margin-top: 8px;
        }

        #settingsSubmitBtn {
            background: linear-gradient(135deg, #d4af37 0%, #aa8c2e 100%);
            width: 100%;
            margin-top: 20px;
            font-size: 20px;
            padding: 15px;
        }

        /* ‰ªÆÊÉ≥„Ç≥„É≥„Éà„É≠„Éº„É©„Éº */
        #virtualControls {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 200px;
            z-index: 5;
            pointer-events: none;
            transition: opacity 0.5s ease;
        }

        #virtualControls.inactive {
            opacity: 0.2;
        }

        .control-btn {
            position: absolute;
            width: 80px;
            height: 80px;
            background: radial-gradient(circle, rgba(212, 175, 55, 0.6), rgba(212, 175, 55, 0.3));
            border: 3px solid rgba(212, 175, 55, 0.8);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            color: #fff;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
            pointer-events: auto;
            transition: all 0.1s;
            user-select: none;
        }

        .control-btn:active {
            background: radial-gradient(circle, rgba(212, 175, 55, 0.9), rgba(212, 175, 55, 0.5));
            transform: scale(0.95);
        }

        #leftBtn {
            bottom: 40px;
            left: 30px;
        }

        #rightBtn {
            bottom: 40px;
            left: 130px;
        }

        #shootBtn {
            bottom: 40px;
            right: 30px;
            width: 100px;
            height: 100px;
            font-size: 20px;
            background: radial-gradient(circle, rgba(255, 107, 0, 0.7), rgba(255, 107, 0, 0.4));
            border-color: rgba(255, 107, 0, 0.9);
        }

        #shootBtn:active {
            background: radial-gradient(circle, rgba(255, 107, 0, 0.95), rgba(255, 107, 0, 0.6));
        }

        /* Special Attack Button */
        #specialBtn {
            bottom: 150px;
            right: 30px;
            width: 100px;
            height: 100px;
            font-size: 16px;
            background: radial-gradient(circle, rgba(128, 128, 128, 0.5), rgba(128, 128, 128, 0.3));
            border-color: rgba(128, 128, 128, 0.8);
        }

        #specialBtn.ready {
            background: radial-gradient(circle, rgba(255, 0, 0, 0.8), rgba(255, 0, 0, 0.5));
            border-color: rgba(255, 0, 0, 1);
            animation: specialPulse 1s ease-in-out infinite;
        }

        #specialBtn.disabled {
            opacity: 0.3;
            pointer-events: none;
        }

        #specialBtn:active {
            background: radial-gradient(circle, rgba(255, 0, 0, 0.95), rgba(255, 0, 0, 0.7));
        }

        @keyframes specialPulse {

            0%,
            100% {
                box-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
            }

            50% {
                box-shadow: 0 0 30px rgba(255, 0, 0, 1);
            }
        }

        /* Hide virtual controls on PC unless mobile mode is active */
        body:not(.mobile-mode) #virtualControls {
            display: none !important;
        }

        .mobile-mode .control-btn {
            width: 70px;
            height: 70px;
            font-size: 24px;
        }

        .mobile-mode #leftBtn {
            left: 20px;
            bottom: 30px;
        }

        .mobile-mode #rightBtn {
            left: 110px;
            bottom: 30px;
        }

        .mobile-mode #shootBtn {
            right: 20px;
            bottom: 30px;
            width: 85px;
            height: 85px;
            font-size: 16px;
            white-space: nowrap;
        }

        .mobile-mode #specialBtn {
            right: 20px;
            bottom: 130px;
            width: 85px;
            height: 85px;
            font-size: 14px;
        }

        /* Version Display */
        #version-display {
            position: absolute;
            bottom: 10px;
            right: 10px;
            font-size: 10px;
            color: rgba(212, 175, 55, 0.6);
            font-family: 'Courier New', monospace;
        }

        .mobile-mode #version-display {
            font-size: 8px;
            bottom: 5px;
            right: 5px;
        }

        .mode-toggle {
            margin-top: 15px;
            font-size: 12px;
            padding: 8px 16px;
            min-width: auto;
            background: rgba(212, 175, 55, 0.2);
            border: 1px solid #d4af37;
            box-shadow: none;
        }

        .mode-toggle {
            margin-top: 15px;
            font-size: 12px;
            padding: 8px 16px;
            min-width: auto;
            background: rgba(212, 175, 55, 0.2);
            border: 1px solid #d4af37;
            box-shadow: none;
        }

        #openSettingsBtn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: transparent;
            border: none;
            color: #d4af37;
            font-size: 32px;
            padding: 0;
            margin: 0;
            width: auto;
            min-width: auto;
            min-height: auto;
            box-shadow: none;
            cursor: pointer;
            z-index: 20;
            text-shadow: 0 0 10px rgba(212, 175, 55, 0.5);
            transition: transform 0.5s ease;
        }

        #openSettingsBtn:hover {
            transform: rotate(90deg);
            text-shadow: 0 0 15px rgba(212, 175, 55, 0.8);
        }

        /* Share Buttons Container */
        .share-buttons {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin-top: 10px;
            width: 100%;
        }

        #gameOverScreen button {
            width: 32%;
            max-width: none;
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            padding: 8px 0;
            min-width: 0;
            line-height: 1.2;
            white-space: nowrap;
        }

        /* X (Twitter) Share Button */
        .share-btn {
            background: linear-gradient(135deg, #1DA1F2 0%, #0d8bd9 100%);
            box-shadow: 0 5px 15px rgba(29, 161, 242, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            min-width: 0;
        }

        .share-btn:hover {
            box-shadow: 0 7px 20px rgba(29, 161, 242, 0.6);
        }

        .share-btn::before {
            content: 'ùïè';
            font-size: 14px;
            font-weight: bold;
        }


        /* Result Image */
        /* Result Image */
        .result-image {
            max-width: 200px;
            margin: -20px auto;
            display: block;
            position: relative;
            position: relative;
            z-index: 1;
        }

        /* Result Stats Grid */
        .result-stats-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin: 14px 0;
            width: 100%;
        }

        .stat-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px 8px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid rgba(212, 175, 55, 0.3);
            min-height: 80px;
        }

        .stat-label {
            font-size: 14px;
            color: #ccc;
            margin-bottom: 4px;
            white-space: nowrap;
        }

        .stat-value {
            font-size: 18px;
            color: #ffd700;
            font-weight: bold;
            line-height: 1.2;
        }

        /* ÁÖ©ÊÇ©„É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫ */
        #bonnouMessageContainer {
            position: fixed;
            top: calc((100vh - 640px) / 2);
            right: 20px;
            width: 260px;
            max-height: 640px;
            overflow-y: auto;
            z-index: 20;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .bonnou-message-item {
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid #ff6f00;
            border-radius: 10px;
            padding: 12px 15px;
            text-align: left;
            animation: slideInRight 0.3s ease-out;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .bonnou-title {
            font-size: 19px;
            color: #ff6f00;
            text-shadow: 0 0 10px rgba(255, 111, 0, 0.8);
            font-weight: bold;
            margin-bottom: 5px;
        }

        .bonnou-desc {
            font-size: 12px;
            color: #ffd700;
            line-height: 1.4;
        }

        /* Mobile: keep original centered display at top */
        .mobile-mode #bonnouMessageContainer {
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            right: auto;
            width: 90%;
            max-width: 350px;
        }

        .mobile-mode .bonnou-message-item {
            text-align: center;
        }

        .mobile-mode .bonnou-title {
            font-size: 18px;
        }

        .mobile-mode .bonnou-desc {
            font-size: 12px;
        }

        @keyframes shake {
            0% {
                transform: translate(0, 0);
            }

            10% {
                transform: translate(-5px, 0);
            }

            20% {
                transform: translate(5px, 0);
            }

            30% {
                transform: translate(-5px, 0);
            }

            40% {
                transform: translate(5px, 0);
            }

            50% {
                transform: translate(-3px, 0);
            }

            60% {
                transform: translate(3px, 0);
            }

            70% {
                transform: translate(-3px, 0);
            }

            80% {
                transform: translate(0, 0);
            }
        }

        .shake {
            animation: shake 0.5s cubic-bezier(.36, .07, .19, .97) both;
        }

        /* ToS & Tutorial Modals */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 300;
        }

        .modal-container {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border: 3px solid #d4af37;
            border-radius: 15px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            text-align: center;
            color: #fff;
            box-shadow: 0 0 50px rgba(212, 175, 55, 0.6);
        }

        .modal-title {
            color: #d4af37;
            font-size: 28px;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(212, 175, 55, 0.3);
            padding-bottom: 10px;
        }

        .tos-content {
            text-align: left;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
            border: 1px solid rgba(212, 175, 55, 0.3);
            height: 200px;
            overflow-y: scroll;
            font-size: 14px;
            line-height: 1.6;
        }

        /* Carousel Styles */
        .carousel-container {
            position: relative;
            width: 100%;
            padding-top: 100%;
            /* Enables square aspect ratio regardless of width */
            margin-bottom: 20px;
            background: #000;
            overflow: hidden;
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 8px;
        }

        .carousel-slide {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
        }

        .carousel-slide.active {
            display: block;
            animation: fadeIn 0.5s;
        }

        .carousel-controls {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }

        .carousel-dots {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .dot {
            width: 10px;
            height: 10px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            cursor: pointer;
        }

        .dot.active {
            background: #d4af37;
        }

        .menu-btn {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border: 2px solid #d4af37;
            color: #fff;
            padding: 12px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
            text-align: center;
        }

        .menu-btn:hover {
            background: #d4af37;
            color: #1a1a2e;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <main>
        <div id="gameContainer">
            <!-- „Çø„Ç§„Éà„É´ÁîªÈù¢ -->
            <div id="titleScreen" class="screen">
                <div id="titleIntroOverlay">
                    <div class="intro-black"></div>
                    <img id="introMonkHappy" class="intro-monk intro-happy" src="images/monk/monk_happy.png" alt="happy monk">
                    <img id="introMonkSad" class="intro-monk intro-sad" src="images/monk/monk_sad.png" alt="sad monk">
                    <img id="introMonkPray" class="intro-monk intro-pray" src="images/monk/monk_pray.png" alt="praying monk">
                </div>
                <div id="titlePersistentPray">
                    <img src="images/monk/monk_pray.png" alt="praying monk">
                </div>

                <div id="titleMainContent">
                    <!-- Floating Menu Button Removed -->
                    <div class="title-logo"></div>
                    <h1>ÁÖ©ÊÇ©ÈÄÄÊï£</h1>
                    <div class="subtitle">„Äú‰øÆË°åÂÉß„ÅÆËëõËó§„Äú</div>

                    <div class="instruction">
                        <p style="font-size: 16px; font-weight: bold; margin-bottom: 10px;">
                            Èôç„ÇäÊ≥®„Åê<span style="color:#ff4444;">ÁÖ©ÊÇ©</span>„ÅÆÈõ®‚Ä¶‚Ä¶<br>
                            Ëø∑„Çè„ÅöÊíÉ„Å¶ÔºÅÊÇü„Çä„ÅØ„Åù„ÅÆÂÖà„Å´„ÅÇ„Çã„ÄÇ
                        </p>
                        <p style="color:#d4af37; font-weight:bold; font-size: 18px;">
                            Á©∂Ê•µ„ÅÆÂæ≥Ôºà„Éè„Ç§„Çπ„Ç≥„Ç¢Ôºâ„ÇíÁõÆÊåá„ÅõÔºÅ
                        </p>
                    </div>

                    <div class="title-buttons">
                        <button id="startBtn" style="width: 200px;">‰øÆË°å„ÅÆÈñãÂßã</button>
                        <button id="rankingBtn" style="width: 200px;">‰øÆË°å„ÅÆËªåË∑°</button>
                        <button id="menuBtn" style="width: 200px; margin-top: 0; font-size: 16px;">‰øÆË°å„ÅÆÊ∫ñÂÇô</button>
                    </div>

                    <div id="version-display"></div>
                </div>
            </div>

            <!-- „É¨„Éô„É´ÈÅ∏ÊäûÁîªÈù¢ -->
            <div id="levelScreen" class="screen hidden">
                <h1>‰øÆË°å„ÅÆÈÅì</h1>
                <h2>Èõ£ÊòìÂ∫¶„ÇíÈÅ∏„Åπ</h2>

                <div class="level-buttons">
                    <button id="levelEasy" class="level-btn">
                        <span class="level-name">‰ªèÊÄßLev1</span>
                        <span class="level-desc">ÁÖ©ÊÇ©36‰Ωì / „ÇÜ„Å£„Åè„Çä</span>
                    </button>
                    <button id="levelNormal" class="level-btn">
                        <span class="level-name">‰ªèÊÄßLev2</span>
                        <span class="level-desc">ÁÖ©ÊÇ©72‰Ωì / ÊôÆÈÄö</span>
                        <span class="level-lock">‰ªèÊÄßLev1„Çí„ÇØ„É™„Ç¢„ÅßËß£Êîæ</span>
                    </button>
                    <button id="levelHard" class="level-btn">
                        <span class="level-name">‰ªèÊÄßLev3</span>
                        <span class="level-desc">ÁÖ©ÊÇ©108‰Ωì / È´òÈÄü</span>
                        <span class="level-lock">‰ªèÊÄßLev2„Çí„ÇØ„É™„Ç¢„ÅßËß£Êîæ</span>
                    </button>
                    <button id="levelDemon" class="level-btn hidden">
                        <span class="level-name">È¨º„É¨„Éô„É´</span>
                        <span class="level-desc">ÁÑ°ÈôêÁÖ©ÊÇ© / Âä†ÈÄüÂú∞ÁçÑ</span>
                    </button>
                </div>


                <button id="backFromLevelBtn">Êàª„Çã</button>
            </div>

            <!-- „Éë„Çπ„ÉØ„Éº„ÉâÂÖ•Âäõ„É¢„Éº„ÉÄ„É´ -->
            <div id="passwordModal" class="screen hidden">
                <div class="password-container">
                    <h2>„É¨„Éô„É´Ëß£Êîæ</h2>
                    <p>
                        „Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„É¨„Éô„É´„ÇíËß£Êîæ<br>
                        <span class="password-hint">‚ÄªÂêÑ„É¨„Éô„É´„Å´ÂØæÂøú„Åô„Çã„Éë„Çπ„ÉØ„Éº„Éâ„Åå„ÅÇ„Çä„Åæ„Åô</span>
                    </p>
                    <input type="password" id="passwordInput" placeholder="„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ" maxlength="20">
                    <div class="password-buttons">
                        <button id="passwordSubmitBtn">Á¢∫Ë™ç</button>
                        <button id="passwordCancelBtn">„Ç≠„É£„É≥„Çª„É´</button>
                    </div>
                    <div id="passwordMessage"></div>
                </div>
            </div>

            <!-- „Ç≤„Éº„É†„Ç™„Éº„Éê„ÉºÁîªÈù¢ -->
            <div id="gameOverScreen" class="screen hidden">
                <h1 id="resultTitle"></h1>
                <h2 id="resultText"></h2>
                <img id="resultImage" class="result-image" src="" alt="result">
                <div id="currentScore"></div>
                <div class="share-buttons">
                    <button id="shareBtn" class="share-btn">ÂÖ±Êúâ</button>
                    <button id="restartBtn">ÂÜç‰øÆË°å</button>
                    <button id="toTitleBtn">„Çø„Ç§„Éà„É´</button>
                </div>
            </div>

            <!-- ÂàùÊúüË®≠ÂÆö„É¢„Éº„ÉÄ„É´ -->
            <div id="settingsModal" class="hidden">
                <div class="settings-container">
                    <h2>Áí∞Â¢ÉË®≠ÂÆö</h2>

                    <div class="setting-group">
                        <span class="setting-label">Èü≥Â£∞Ë®≠ÂÆö</span>
                        <div class="toggle-options">
                            <button class="toggle-btn active" data-group="sound" data-value="on">ON (BGM„ÅÇ„Çä)</button>
                            <button class="toggle-btn" data-group="sound" data-value="off">OFF (ÁÑ°Èü≥)</button>
                        </div>
                        <div class="settings-desc">‚Äª„ÄåON„Äç„ÅÆÂ†¥Âêà„ÄÅÈñãÂßãÊôÇ„Å´Èü≥Â£∞„ÅåÂÜçÁîü„Åï„Çå„Åæ„Åô</div>
                    </div>

                    <div class="setting-group">
                        <span class="setting-label">Êìç‰Ωú„É¢„Éº„Éâ</span>
                        <div class="toggle-options">
                            <button class="toggle-btn" data-group="mode" data-value="pc">PC („Ç≠„Éº„Éú„Éº„Éâ)</button>
                            <button class="toggle-btn" data-group="mode" data-value="mobile">„Çπ„Éû„Éõ („Çø„ÉÉ„Éó)</button>
                        </div>
                        <div class="settings-desc">‚Äª„Éá„Éï„Ç©„É´„Éà„ÅØPC„Åß„Åô</div>
                    </div>

                    <button id="settingsSubmitBtn">Ê±∫ÂÆö</button>
                </div>
            </div>

            <!-- Âà©Áî®Ë¶èÁ¥Ñ„É¢„Éº„ÉÄ„É´ -->
            <div id="tosModal" class="modal hidden">
                <div class="modal-container">
                    <h2 class="modal-title">Âà©Áî®Ë¶èÁ¥Ñ</h2>
                    <div class="tos-content">
                        <p><strong>Á¨¨1Êù°ÔºàÁõÆÁöÑÔºâ</strong></p>
                        <p>Êú¨Ë¶èÁ¥Ñ„ÅØ„ÄÅÂΩì„Ç≤„Éº„É†„ÄåÁÖ©ÊÇ©ÈÄÄÊï£„Äç„ÅÆÂà©Áî®„Å´Èñ¢„Åô„ÇãÊù°‰ª∂„ÇíÂÆö„ÇÅ„Çã„ÇÇ„ÅÆ„Åß„Åô„ÄÇ</p>
                        <br>
                        <p><strong>Á¨¨2Êù°ÔºàÂÖçË≤¨Ôºâ</strong></p>
                        <p>Êú¨„Ç≤„Éº„É†„ÅÆÂà©Áî®„Å´„Çà„ÇäÁîü„Åò„ÅüÊêçÂÆ≥„Å´„Å§„ÅÑ„Å¶„ÄÅÈñãÁô∫ËÄÖ„ÅØ‰∏ÄÂàá„ÅÆË≤¨‰ªª„ÇíË≤†„ÅÑ„Åæ„Åõ„Çì„ÄÇ</p>
                        <br>
                        <p><strong>Á¨¨3Êù°ÔºàÁ¶ÅÊ≠¢‰∫ãÈ†ÖÔºâ</strong></p>
                        <p>ÂÖ¨Â∫èËâØ‰øó„Å´Âèç„Åô„ÇãË°åÁÇ∫„ÄÅ‰∏çÊ≠£„Ç¢„ÇØ„Çª„Çπ„ÄÅ„Åù„ÅÆ‰ªñÈñãÁô∫ËÄÖ„Åå‰∏çÈÅ©Âàá„Å®Âà§Êñ≠„Åô„ÇãË°åÁÇ∫„ÇíÁ¶ÅÊ≠¢„Åó„Åæ„Åô„ÄÇ</p>
                        <br>
                        <p><strong>Á¨¨4Êù°ÔºàÂ§âÊõ¥Ôºâ</strong></p>
                        <p>Êú¨Ë¶èÁ¥Ñ„ÅØ‰∫àÂëä„Å™„ÅèÂ§âÊõ¥„Åï„Çå„ÇãÂ†¥Âêà„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ</p>
                        <br>
                        <p>„Ç≤„Éº„É†„Çí„ÅäÊ•Ω„Åó„Åø„ÅÑ„Åü„Å†„ÅèÂâç„Å´„ÄÅ‰∏äË®òÂÜÖÂÆπ„Çí„ÅîÁ¢∫Ë™ç„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
                    </div>
                    <button id="tosAgreeBtn">ÂêåÊÑè„Åô„Çã</button>
                </div>
            </div>

            <!-- „ÉÅ„É•„Éº„Éà„É™„Ç¢„É´„É¢„Éº„ÉÄ„É´ -->
            <div id="tutorialModal" class="modal hidden">
                <div class="modal-container">
                    <h2 class="modal-title">‰øÆË°å„ÅÆÂøÉÂæó</h2>

                    <div class="carousel-container">
                        <img src="images/tutorial/slide1.png" class="carousel-slide active" alt="Âü∫Êú¨Êìç‰Ωú">
                        <img src="images/tutorial/slide2.png" class="carousel-slide" alt="ÁÖ©ÊÇ©„ÇíÊíÉ„Å¶">
                        <img src="images/tutorial/slide3.png" class="carousel-slide" alt="ÂÖ≠Ê≥¢ÁæÖËúú„ÇíÈõÜ„ÇÅ„Çà">
                    </div>

                    <div class="carousel-dots">
                        <span class="dot active" onclick="setSlide(0)"></span>
                        <span class="dot" onclick="setSlide(1)"></span>
                        <span class="dot" onclick="setSlide(2)"></span>
                    </div>

                    <div class="carousel-controls">
                        <button id="prevSlideBtn" style="min-width:100px;">Ââç„Å∏</button>
                        <button id="nextSlideBtn" style="min-width:100px;">Ê¨°„Å∏</button>
                    </div>
                </div>
            </div>

            <!-- „É©„É≥„Ç≠„É≥„Ç∞ÁîªÈù¢ -->
            <div id="rankingScreen" class="screen hidden">
                <h1>„É©„É≥„Ç≠„É≥„Ç∞</h1>
                <h2>Ê≠¥‰ª£„ÅÆÂêçÂÉß„Åü„Å°</h2>

                <div id="rankingList"></div>

                <button id="backToTitleBtn">„Çø„Ç§„Éà„É´„Å´Êàª„Çã</button>
            </div>

            <canvas id="gameCanvas" width="480" height="640"></canvas>

            <div id="info" class="hidden">
                <div><span id="levelDisplay"></span> | ÁÖ©ÊÇ©ÈÄÄÊï£: <span id="score">0</span> / <span
                        id="targetScore">108</span>
                </div>
                <div>Á≤æÁ•ûÂäõ: <span id="spirit">3</span> | ÂäüÂæ≥: <span id="kudoku" style="color:#fff">0</span>/6 | ÈÄ£ÈéñÊï∞: <span
                        id="combo">0</span></div>
            </div>

            <!-- ‰ªÆÊÉ≥„Ç≥„É≥„Éà„É≠„Éº„É©„ÉºÔºà„Çπ„Éû„ÉõÁî®Ôºâ -->
            <div id="virtualControls" class="hidden">
                <div id="leftBtn" class="control-btn">‚óÄ</div>
                <div id="rightBtn" class="control-btn">‚ñ∂</div>
                <div id="shootBtn" class="control-btn">Ë™≠ÁµåÁô∫Â∞Ñ</div>
                <div id="specialBtn" class="control-btn disabled">ÁÖ©ÊÇ©Âç≥Ëè©Ëñ©</div>
            </div>
        </div>

        <!-- „É°„Éã„É•„Éº„É¢„Éº„ÉÄ„É´ -->
        <div id="menuModal" class="modal hidden">
            <div class="modal-container" style="max-width: 300px; text-align: center;">
                <h2 style="color: #d4af37; margin-bottom: 20px;">„É°„Éã„É•„Éº</h2>
                <div style="display: flex; flex-direction: column; gap: 15px;">
                    <button id="menuSettingsBtn" class="menu-btn">Ë®≠ÂÆö</button>
                    <button id="menuTosBtn" class="menu-btn">Âà©Áî®Ë¶èÁ¥Ñ</button>
                    <button id="menuTutorialBtn" class="menu-btn">‰øÆË°å„ÅÆÂøÉÂæó</button>

                    <button id="closeMenuBtn" class="menu-btn"
                        style="margin-top: 10px; background: #555; border-color: #777;">Èñâ„Åò„Çã</button>
                </div>
            </div>
        </div>

        <!-- ÁÖ©ÊÇ©„É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫ -->
        <div id="bonnouMessageContainer"></div>
    </main>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // ÁîªÈù¢Ë¶ÅÁ¥†
        const titleScreen = document.getElementById('titleScreen');
        const titleIntroOverlay = document.getElementById('titleIntroOverlay');
        const titleMainContent = document.getElementById('titleMainContent');
        const titlePersistentPray = document.getElementById('titlePersistentPray');
        const introMonkHappy = document.getElementById('introMonkHappy');
        const introMonkSad = document.getElementById('introMonkSad');
        const introMonkPray = document.getElementById('introMonkPray');
        const levelScreen = document.getElementById('levelScreen');
        const gameOverScreen = document.getElementById('gameOverScreen');
        const rankingScreen = document.getElementById('rankingScreen');
        const infoPanel = document.getElementById('info');
        const virtualControls = document.getElementById('virtualControls');

        // „Éú„Çø„É≥
        const startBtn = document.getElementById('startBtn');
        const restartBtn = document.getElementById('restartBtn');
        const rankingBtn = document.getElementById('rankingBtn');
        // const tutorialBtn = document.getElementById('tutorialBtn'); // Title button removed
        const backToTitleBtn = document.getElementById('backToTitleBtn');
        const toTitleBtn = document.getElementById('toTitleBtn');

        // ToS & Tutorial Elements
        const tosModal = document.getElementById('tosModal');
        const tosAgreeBtn = document.getElementById('tosAgreeBtn');
        const tutorialModal = document.getElementById('tutorialModal');
        const prevSlideBtn = document.getElementById('prevSlideBtn');
        const nextSlideBtn = document.getElementById('nextSlideBtn');
        const slides = document.querySelectorAll('.carousel-slide');
        const dots = document.querySelectorAll('.dot');
        let currentSlide = 0;

        // ‰ªÆÊÉ≥„Ç≥„É≥„Éà„É≠„Éº„É©„Éº„Éú„Çø„É≥
        const leftBtn = document.getElementById('leftBtn');
        const rightBtn = document.getElementById('rightBtn');
        const shootBtn = document.getElementById('shootBtn');
        const specialBtn = document.getElementById('specialBtn');

        // „Çø„ÉÉ„ÉÅÊìç‰Ωú„ÅÆÁä∂ÊÖã
        let touchLeft = false;
        let touchRight = false;
        let touchSpecial = false;

        // „Ç™„Éº„Éà„Éè„Ç§„ÉâÊ©üËÉΩÁî®
        let lastInputTime = Date.now();
        const HIDE_DELAY = 3000; // 3Áßí„ÅßÈùûË°®Á§∫

        // ÁîªÂÉè„É™„ÇΩ„Éº„Çπ
        const monkImage = new Image();
        monkImage.src = 'images/monk/monk_back.png';

        // BGM„Å®ÂäπÊûúÈü≥
        const sounds = {
            bgm: new Audio('sounds/bgm.wav'),
            shoot: new Audio('sounds/shoot.mp3'),
            hit: new Audio('sounds/hit.mp3'),
            hit_bounas: new Audio('sounds/hit_bounas.mp3'),
            damage: new Audio('sounds/damage.mp3'),
            gameover: new Audio('sounds/gameover.mp3'),
            clear: new Audio('sounds/clear.mp3')
        };

        // BGM„ÅÆË®≠ÂÆö
        sounds.bgm.loop = true;
        sounds.bgm.volume = 0.5;

        // ÂäπÊûúÈü≥„ÅÆÈü≥ÈáèË®≠ÂÆö
        sounds.shoot.volume = 0.3;
        sounds.hit.volume = 0.4;
        sounds.damage.volume = 0.5;
        sounds.gameover.volume = 0.6;
        sounds.clear.volume = 0.6;

        // Èü≥Â£∞ÂÜçÁîü„ÅÆ„Éò„É´„Éë„ÉºÈñ¢Êï∞
        function playSound(soundName) {
            if (sounds[soundName]) {
                sounds[soundName].currentTime = 0;
                sounds[soundName].play().catch(e => console.log('Audio play failed:', e));
            }
        }

        function stopSound(soundName) {
            if (sounds[soundName]) {
                sounds[soundName].pause();
                sounds[soundName].currentTime = 0;
            }
        }

        // „É¢„Éê„Ç§„É´Á≠â„ÅÆËá™ÂãïÂÜçÁîüÂà∂ÈôêËß£Èô§Áî®
        let audioUnlocked = false;
        function unlockAudio() {
            if (audioUnlocked) return;

            // ÂÖ®„Å¶„ÅÆÈü≥Â£∞„ÇíÁÑ°Èü≥„Åß‰∏ÄÁû¨ÂÜçÁîü„Åó„Å¶„Ç¢„É≥„É≠„ÉÉ„ÇØ
            Object.values(sounds).forEach(audio => {
                audio.muted = true;
                audio.play().then(() => {
                    audio.pause();
                    audio.currentTime = 0;
                    audio.muted = false;
                }).catch(e => {
                    console.log('Audio unlock failed:', e);
                    audio.muted = false;
                });
            });

            audioUnlocked = true;

            // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºÂâäÈô§
            document.removeEventListener('touchstart', unlockAudio);
            document.removeEventListener('click', unlockAudio);
            document.removeEventListener('keydown', unlockAudio);
        }

        document.addEventListener('touchstart', unlockAudio, { passive: true });
        document.addEventListener('click', unlockAudio);
        document.addEventListener('keydown', unlockAudio);

        // „Ç≤„Éº„É†Áä∂ÊÖã
        let gameState = 'title'; // 'title', 'level', 'playing', 'gameover', 'ranking'
        let score = 0;
        let spirit = 3;      // Á≤æÁ•ûÂäõÔºàHP„Ç∑„Çπ„ÉÜ„É†Ôºâ
        let maxSpirit = 3;   // ÁèæÂú®Èõ£ÊòìÂ∫¶„Åß„ÅÆÊúÄÂ§ßÁ≤æÁ•ûÂäõ
        let kudoku = 0;      // ÂäüÂæ≥ÔºàMP„Ç∑„Çπ„ÉÜ„É†Ôºâ
        const maxKudoku = 6; // ÊúÄÂ§ßÂäüÂæ≥
        let combo = 0;
        let maxCombo = 0;
        let frame = 0;
        let lastBonnou = ''; // ÊúÄÂæå„Å´„ÇÑ„Çâ„Çå„ÅüÁÖ©ÊÇ©
        let heartFlashUntil = 0;
        let heartImpactUntil = 0;
        let heartPurifyUntil = 0;
        let heartStains = [];
        let titleIntroPlayed = false;
        let titleIntroRunning = false;
        let titleIntroTimers = [];

        // ÁÖ©ÊÇ©„É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫
        const bonnouMessageContainer = document.getElementById('bonnouMessageContainer');

        function showBonnouMessage(bonnouText) {
            // „É°„ÉÉ„Çª„Éº„Ç∏„Ç¢„Ç§„ÉÜ„É†„Çí‰ΩúÊàê
            const description = bonnouDescriptions[bonnouText] || 'ÂøÉ„Çí‰π±„ÅôÁÖ©ÊÇ©';
            const messageItem = document.createElement('div');
            messageItem.className = 'bonnou-message-item';
            messageItem.innerHTML = `
                <div class="bonnou-title">„Äå${bonnouText}„Äç</div>
                <div class="bonnou-desc">${description}</div>
            `;

            // „Ç≥„É≥„ÉÜ„Éä„Å´ËøΩÂä†ÔºàÊúÄÊñ∞„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏„Åå‰∏ä„Å´Êù•„Çã„Çà„ÅÜ„Å´Ôºâ
            bonnouMessageContainer.insertBefore(messageItem, bonnouMessageContainer.firstChild);

            // „Çπ„Éû„Éõ„ÅÆÂ†¥ÂêàÔºàmobile-modeÔºâ„ÄÅ3ÁßíÁµå„Å£„Åü„ÇâÊ∂à„Åà„Çã„Çà„ÅÜ„Å´„Åô„Çã
            if (document.body.classList.contains('mobile-mode')) {
                setTimeout(() => {
                    messageItem.style.transition = 'opacity 0.5s';
                    messageItem.style.opacity = '0';
                    setTimeout(() => {
                        if (messageItem.parentNode) {
                            messageItem.remove();
                        }
                    }, 500);
                }, 3000);
            }
        }

        function triggerHeartBreach(x) {
            const now = performance.now();
            heartFlashUntil = now + 260;
            heartImpactUntil = now + 260;

            const safeMaxSpirit = Math.max(1, maxSpirit);
            const dangerRatio = 1 - Math.max(0, spirit) / safeMaxSpirit;
            heartStains.push({
                x: Math.max(0, Math.min(canvas.width, x)),
                width: 42 + Math.random() * 34,
                createdAt: now,
                duration: 2600 + dangerRatio * 2200,
                maxAlpha: 0.28 + dangerRatio * 0.25
            });

            if (heartStains.length > 18) heartStains.shift();
        }

        function triggerHeartPurify() {
            heartPurifyUntil = performance.now() + 800;
        }


        // Èõ£ÊòìÂ∫¶Ë®≠ÂÆö
        let currentLevel = 'normal';
        let targetScore = 108; // „ÇØ„É™„Ç¢„Å´ÂøÖË¶Å„Å™ÊíÉÁ†¥Êï∞
        let baseSpeed = 1; // Âü∫Êú¨ÈÄüÂ∫¶
        let spawnRate = 40; // ÊïµÂá∫ÁèæÈñìÈöîÔºàÂ∞è„Åï„ÅÑ„Åª„Å©È†ªÁπÅÔºâ

        const levelSettings = {
            easy: {
                name: '‰ªèÊÄßLev1',
                targetScore: 36,
                baseSpeed: 1.0,
                spawnRate: 30, // Reduced from 50 (faster spawn)
                speedIncrease: 0.04,
                isInfinite: false,
                initialSpirit: 3
            },
            normal: {
                name: '‰ªèÊÄßLev2',
                targetScore: 72,
                baseSpeed: 1.5,
                spawnRate: 25, // Reduced from 40
                speedIncrease: 0.06,
                isInfinite: false,
                initialSpirit: 4
            },
            hard: {
                name: '‰ªèÊÄßLev3',
                targetScore: 108,
                baseSpeed: 2.5,
                spawnRate: 20, // Reduced from 30
                speedIncrease: 0.08,
                isInfinite: false,
                initialSpirit: 5
            },
            demon: {
                name: 'È¨º„É¨„Éô„É´',
                targetScore: 999999, // ÂÆüË≥™ÁÑ°Èôê
                baseSpeed: 3.0,
                spawnRate: 15, // Reduced from 25
                speedIncrease: 0.12, // „Çà„ÇäÈÄü„ÅèÂä†ÈÄü
                isInfinite: true,
                initialSpirit: 5
            }
        };

        // ÁÖ©ÊÇ©„ÅÆ„É™„Çπ„Éà
        const bonnouList = [
            'Ë≤™Ê¨≤', 'ÁûãÊÅö', 'ÊÑöÁó¥', 'ÊÖ¢ÂøÉ', 'ÁñëÊÉë', 'ÈÇ™Ë¶ã',
            'ÊÄí„Çä', 'Âü∑ÁùÄ', 'Â´âÂ¶¨', 'ÂÇ≤ÊÖ¢', 'ÊÄ†ÊÉ∞', 'ÁÑ°Áü•',
            'Ê¨≤Êúõ', 'ÊÜéÊÇ™', 'Ëø∑„ÅÑ', 'Â¶ÑÊÉ≥', 'ÁÖ©ÊÇ∂', 'Ëã¶ÊÇ©',
            'Ê∏áÊÑõ', 'ÊàëÂü∑', 'ÈÇ™Âøµ', 'ÈõëÂøµ', 'Â¶ÑÂü∑', 'ÁÖ©„ÅÑ',
            '‰∏çÂÆâ', 'ÊÅêÊÄñ', 'ÂæåÊÇî', 'ÁÑ¶Áá•', 'Áµ∂Êúõ', 'Â≠§Áã¨'
        ];

        // ÁÖ©ÊÇ©„ÅÆË™¨Êòé„Å®ÂØæÂá¶Ê≥ï
        const bonnouDescriptions = {
            'Ë≤™Ê¨≤': 'Èôê„Çä„Å™„ÅÑÊ¨≤Êúõ ‚Üí Ë∂≥„Çã„ÇíÁü•„ÇãÂøÉ„ÅßÂØæÂá¶',
            'ÁûãÊÅö': 'ÊøÄ„Åó„ÅÑÊÄí„Çä ‚Üí ÊÖàÊÇ≤„ÅÆÂøÉ„ÅßÈéÆ„ÇÅ„Çã',
            'ÊÑöÁó¥': 'ÁúüÁêÜ„Å∏„ÅÆÁÑ°Áü• ‚Üí Êô∫ÊÖß„ÇíÁ£®„ÅÑ„Å¶ÂÖãÊúç',
            'ÊÖ¢ÂøÉ': 'ÂÇ≤ÊÖ¢„Å™ÂøÉ ‚Üí Ë¨ôËôö„Åï„ÇíÂøò„Çå„Åö„Å´',
            'ÁñëÊÉë': 'Áñë„ÅÑ„ÅÆÂøÉ ‚Üí ‰ø°„Åò„ÇãÂøÉ„ÇíÊåÅ„Å§',
            'ÈÇ™Ë¶ã': 'Ë™§„Å£„ÅüË¶ãËß£ ‚Üí Ê≠£„Åó„ÅÑÁêÜËß£„ÇíÊ±Ç„ÇÅ„Çã',
            'ÊÄí„Çä': 'ÂøÉ„Çí‰π±„ÅôÊÑüÊÉÖ ‚Üí Ê∑±ÂëºÂê∏„ÅßÂøÉ„ÇíËêΩ„Å°ÁùÄ„Åë„Çã',
            'Âü∑ÁùÄ': 'ÊâãÊîæ„Åõ„Å™„ÅÑÂøÉ ‚Üí ÁÑ°Â∏∏„ÇíÂèó„ÅëÂÖ•„Çå„Çã',
            'Â´âÂ¶¨': '‰ªñËÄÖ„ÇíÂ¶¨„ÇÄÂøÉ ‚Üí Ëá™ÂàÜ„ÅÆÈÅì„ÇíÊ≠©„ÇÄ',
            'ÂÇ≤ÊÖ¢': 'Ëá™Â∑±„ÇíÈÅé‰ø° ‚Üí ‰ªñËÄÖ„Åã„ÇâÂ≠¶„Å∂ÂßøÂã¢„Çí',
            'ÊÄ†ÊÉ∞': 'ÊÄ†„Åë„ÇãÂøÉ ‚Üí Á≤æÈÄ≤„ÅÆÂøÉ„ÅßÂÖãÊúç',
            'ÁÑ°Áü•': 'Áü•„Çâ„Å™„ÅÑ„Åì„Å® ‚Üí Â≠¶„Å≥Á∂ö„Åë„ÇãÂøÉ„Çí',
            'Ê¨≤Êúõ': 'ÈöõÈôê„Å™„ÅÑÊ¨≤Ê±Ç ‚Üí ÂøÖË¶ÅÂçÅÂàÜ„ÇíÁü•„Çã',
            'ÊÜéÊÇ™': 'ÊÜé„Åó„Åø„ÅÆÂøÉ ‚Üí Ë®±„Åó„ÅÆÂøÉ„ÅßËß£Êîæ',
            'Ëø∑„ÅÑ': 'ÈÅì„Å´Ëø∑„ÅÜÂøÉ ‚Üí ÁõÆÁöÑ„ÇíÊòéÁ¢∫„Å´',
            'Â¶ÑÊÉ≥': 'ÁèæÂÆüÈõ¢„Çå„Åó„ÅüÊÄùËÄÉ ‚Üí ‰ªä„Åì„Åì„Å´ÈõÜ‰∏≠',
            'ÁÖ©ÊÇ∂': 'ÂøÉ„ÅÆËã¶„Åó„Åø ‚Üí Âèó„ÅëÂÖ•„Çå„Çã„Åì„Å®„Åã„Çâ',
            'Ëã¶ÊÇ©': 'Ê∑±„ÅÑÊÇ©„Åø ‚Üí ‰∏Ä„Å§„Åö„Å§Ëß£Ê±∫„Çí',
            'Ê∏áÊÑõ': 'Ê∏á„Åè„Çà„ÅÜ„Å™Ê¨≤Êúõ ‚Üí ÊÑüË¨ù„ÅÆÂøÉ„ÅßÊ∫Ä„Åü„Åô',
            'ÊàëÂü∑': 'Ëá™Êàë„Å∏„ÅÆÂü∑ÁùÄ ‚Üí ÁÑ°Êàë„ÅÆÂ¢ÉÂú∞„Å∏',
            'ÈÇ™Âøµ': 'ÈÇ™„Å™ËÄÉ„Åà ‚Üí Ê≠£„Åó„ÅÑÊÄùËÄÉ„Çí‰øù„Å§',
            'ÈõëÂøµ': 'Êï£Êº´„Å™ÊÄùËÄÉ ‚Üí ÁûëÊÉ≥„ÅßÂøÉ„ÇíÊï¥„Åà„Çã',
            'Â¶ÑÂü∑': 'Ë™§„Å£„ÅüÂü∑ÁùÄ ‚Üí ÁúüÂÆü„ÇíË¶ãÊ•µ„ÇÅ„Çã',
            'ÁÖ©„ÅÑ': 'ÂøÉ„ÅÆÁÖ©„Çè„Åó„Åï ‚Üí ÈùôÂØÇ„ÅÆ‰∏≠„Åß‰ºë„ÇÄ',
            '‰∏çÂÆâ': 'ÂÖà„Å∏„ÅÆÊÅê„Çå ‚Üí ‰ªä„ÇíÂ§ßÂàá„Å´Áîü„Åç„Çã',
            'ÊÅêÊÄñ': 'ÊÅê„Çå„ÅÆÊÑüÊÉÖ ‚Üí ÂãáÊ∞ó„ÇíÊåÅ„Å£„Å¶Âêë„ÅçÂêà„ÅÜ',
            'ÂæåÊÇî': 'ÈÅéÂéª„Å∏„ÅÆÂõö„Çè„Çå ‚Üí ‰ªä„Åã„ÇâÂßã„ÇÅ„Çã',
            'ÁÑ¶Áá•': 'ÁÑ¶„ÇãÂøÉ ‚Üí „ÇÜ„Å£„Åè„ÇäÁùÄÂÆü„Å´',
            'Áµ∂Êúõ': 'Â∏åÊúõ„ÇíÂ§±„ÅÜ ‚Üí Â∞è„Åï„Å™ÂÖâ„ÇíË¶ã„Å§„Åë„Çã',
            'Â≠§Áã¨': 'Â≠§Á´ãÊÑü ‚Üí „Å§„Å™„Åå„Çä„ÇíÊÑü„Åò„Çã'
        };

        // „Éó„É¨„Ç§„É§„Éº
        const player = {
            x: canvas.width / 2,
            y: canvas.height - 80,
            width: 40,
            height: 40,
            speed: 12 // Doubled from 6
        };

        // „Ç≠„ÉºÂÖ•Âäõ
        const keys = {};
        let canShoot = true;
        let shootCooldown = 0;

        // „Ç≤„Éº„É†„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà
        const bullets = [];
        const enemies = [];
        const particles = [];

        // „É©„É≥„Ç≠„É≥„Ç∞„Éá„Éº„Çø
        function loadRankings() {
            const saved = localStorage.getItem('nenbunRankings');
            return saved ? JSON.parse(saved) : [];
        }

        function saveRanking(score, combo) {
            const rankings = loadRankings();
            const now = new Date();
            rankings.push({
                score: score,
                combo: combo,
                level: currentLevel,
                levelName: levelSettings[currentLevel].name,
                target: targetScore,
                date: now.toLocaleDateString('ja-JP')
            });
            rankings.sort((a, b) => b.score - a.score);
            rankings.splice(10); // ‰∏ä‰Ωç10‰ª∂„ÅÆ„Åø‰øùÂ≠ò
            localStorage.setItem('nenbunRankings', JSON.stringify(rankings));
        }

        // „É¨„Éô„É´ÈÄ≤Ë°å„Ç∑„Çπ„ÉÜ„É†
        function loadClearedLevels() {
            const saved = localStorage.getItem('nenbunClearedLevels');
            return saved ? JSON.parse(saved) : [];
        }

        function saveClearedLevel(level) {
            const cleared = loadClearedLevels();
            if (!cleared.includes(level)) {
                cleared.push(level);
                localStorage.setItem('nenbunClearedLevels', JSON.stringify(cleared));
            }
        }

        function isLevelUnlocked(level) {
            const cleared = loadClearedLevels();
            if (level === 'easy') return true; // ‰ªèÊÄßLev1„ÅØÂ∏∏„Å´Ëß£Êîæ
            if (level === 'normal') return cleared.includes('easy'); // ‰ªèÊÄßLev2„ÅØLev1„ÇØ„É™„Ç¢„ÅßËß£Êîæ
            if (level === 'hard') return cleared.includes('normal'); // ‰ªèÊÄßLev3„ÅØLev2„ÇØ„É™„Ç¢„ÅßËß£Êîæ
            if (level === 'demon') return cleared.includes('hard'); // È¨º„É¨„Éô„É´„ÅØLev3„ÇØ„É™„Ç¢„ÅßËß£Êîæ
            return false;
        }

        function displayRankings() {
            const rankings = loadRankings();
            const rankingList = document.getElementById('rankingList');

            if (rankings.length === 0) {
                rankingList.innerHTML = '<p style="color: #888; padding: 20px;">„Åæ„Å†Ë®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
                return;
            }

            let html = '';
            rankings.forEach((rank, index) => {
                const isTop3 = index < 3;
                const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : '';
                const levelLabel = rank.levelName || '‰∏≠Á¥ö';
                html += `
                    <div class="rank-item ${isTop3 ? 'top3' : ''}">
                        <span class="rank-number">${medal} ${index + 1}‰Ωç</span>
                        <span class="rank-score">[${levelLabel}] ${rank.score}‰ΩìÊíÉÁ†¥ (ÈÄ£Èéñ√ó${rank.combo})</span>
                        <span class="rank-date">${rank.date}</span>
                    </div>
                `;
            });
            rankingList.innerHTML = html;
        }

        // „É¶„Éº„Ç∂„ÉºÂÖ•Âäõ„Åß„Çø„Ç§„Éû„Éº„É™„Çª„ÉÉ„Éà
        function resetInputTimer() {
            // „Éó„É¨„Ç§‰∏≠‰ª•Â§ñ„ÅØÂá¶ÁêÜ„Åó„Å™„ÅÑÔºà„Åü„Å†„Åó„Çπ„Çø„Éº„ÉàÊôÇ„Å™„Å©„ÅØ„É™„Çª„ÉÉ„Éà„Åó„Åü„ÅÑ„Åã„ÇÇÔºü„Å®„Çä„ÅÇ„Åà„Åö„Éó„É¨„Ç§‰∏≠„ÅÆ„Åø„ÅßOKÔºâ
            lastInputTime = Date.now();
            if (virtualControls.classList.contains('inactive')) {
                virtualControls.classList.remove('inactive');
            }
        }

        window.addEventListener('touchstart', resetInputTimer, { passive: true });
        window.addEventListener('mousedown', resetInputTimer);
        window.addEventListener('keydown', resetInputTimer);

        // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
        document.addEventListener('keydown', (e) => {
            if (gameState === 'playing') {
                if (e.key === 'ArrowLeft') keys['ArrowLeft'] = true;
                if (e.key === 'ArrowRight') keys['ArrowRight'] = true;
                if (e.key === ' ' && canShoot) {
                    e.preventDefault(); // Prevent default spacebar action (scrolling)
                    shootBullet();
                    canShoot = false;
                    shootCooldown = 10;
                }
                // Special attack with Z key
                if ((e.key === 'z' || e.key === 'Z') && kudoku >= maxKudoku) {
                    activateSpecialAttack();
                }
            } else {
                keys[e.key] = true; // Keep general key tracking for non-playing states if needed
            }
        });

        document.addEventListener('keyup', (e) => {
            keys[e.key] = false;
        });

        titleIntroOverlay.addEventListener('click', skipTitleIntro);
        titleIntroOverlay.addEventListener('touchstart', skipTitleIntro, { passive: true });
        document.addEventListener('keydown', () => {
            if (titleIntroRunning) {
                skipTitleIntro();
            }
        });

        startBtn.addEventListener('click', showLevelSelect);
        restartBtn.addEventListener('click', showLevelSelect);
        rankingBtn.addEventListener('click', showRanking);
        backToTitleBtn.addEventListener('click', showTitle);
        toTitleBtn.addEventListener('click', showTitle);

        // X (Twitter) „Ç∑„Çß„Ç¢„Éú„Çø„É≥
        const shareBtn = document.getElementById('shareBtn');
        shareBtn.addEventListener('click', shareToTwitter);

        // Mobile Mode Logic
        function checkMobileMode() {
            // Check for saved setting first
            const savedSettings = localStorage.getItem('nenbunSettings');
            if (savedSettings) {
                const settings = JSON.parse(savedSettings);
                if (settings.mode === 'mobile') {
                    document.body.classList.add('mobile-mode');
                } else {
                    document.body.classList.remove('mobile-mode');
                }
                return;
            }

            // Fallback to width check if no setting saved
            if (window.innerWidth <= 500) {
                document.body.classList.add('mobile-mode');
            } else {
                document.body.classList.remove('mobile-mode');
            }
        }

        // Run initial check
        checkMobileMode();

        function shareToTwitter() {
            const levelName = levelSettings[currentLevel].name;
            const settings = levelSettings[currentLevel];
            const targetDisplay = settings.isInfinite ? '‚àû' : targetScore;
            const isWin = score >= targetScore && !settings.isInfinite;

            // „Ç∑„Çß„Ç¢„ÉÜ„Ç≠„Çπ„Éà„Çí‰ΩúÊàê
            let shareText = `ÁÖ©ÊÇ©ÈÄÄÊï£„Äú‰øÆË°åÂÉß„ÅÆËëõËó§„Äú\n`;
            shareText += `„Äê${levelName}„Äë\n`;

            if (isWin) {
                shareText += `‚ú®‰ªèÊÄß„ÅåËÇ≤„Å°„Åæ„Åó„ÅüÔºÅ‚ú®\n`;
            } else {
                shareText += `ÁÖ©ÊÇ©„Å´Âëë„Åæ„Çå„Åü...\n`;
            }

            shareText += `ÊíÉÁ†¥Êï∞: ${score}/${targetDisplay}\n`;
            shareText += `ÊúÄÂ§ßÈÄ£Èéñ: ${maxCombo}\n`;

            // „Éè„ÉÉ„Ç∑„É•„Çø„Ç∞„ÇíËøΩÂä†
            shareText += `\n#ÁÖ©ÊÇ©ÈÄÄÊï£ #Ëà¨Ëã•ÂøÉÁµåEDM\n`;
            shareText += `\nhttps://tyukei.github.io/nenbutsu-muso/`;

            // X (Twitter) „ÅÆ„Ç∑„Çß„Ç¢URL„Çí‰ΩúÊàê
            const twitterUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}`;

            // Êñ∞„Åó„ÅÑ„Ç¶„Ç£„É≥„Éâ„Ç¶„ÅßÈñã„Åè
            window.open(twitterUrl, '_blank', 'width=550,height=420');
        }


        // „É¨„Éô„É´ÈÅ∏Êäû„Éú„Çø„É≥
        document.getElementById('levelEasy').addEventListener('click', () => {
            playSound('hit');
            startGame('easy');
        });
        document.getElementById('levelNormal').addEventListener('click', () => {
            playSound('hit');
            startGame('normal');
        });
        document.getElementById('levelHard').addEventListener('click', () => {
            playSound('hit');
            startGame('hard');
        });
        document.getElementById('levelDemon').addEventListener('click', () => {
            playSound('hit');
            startGame('demon');
        });
        document.getElementById('backFromLevelBtn').addEventListener('click', showTitle);

        // „Éë„Çπ„ÉØ„Éº„ÉâËß£Êîæ„Éú„Çø„É≥
        const passwordModal = document.getElementById('passwordModal');
        const passwordInput = document.getElementById('passwordInput');
        const passwordMessage = document.getElementById('passwordMessage');

        const passwordSubmitBtn = document.getElementById('passwordSubmitBtn');
        const passwordCancelBtn = document.getElementById('passwordCancelBtn');



        passwordCancelBtn.addEventListener('click', () => {
            passwordModal.classList.add('hidden');
        });

        passwordSubmitBtn.addEventListener('click', checkPassword);

        passwordInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                checkPassword();
            }
        });

        function checkPassword() {
            const password = passwordInput.value.trim();
            const cleared = loadClearedLevels();
            let unlocked = false;
            let message = '';

            // „Éë„Çπ„ÉØ„Éº„Éâ„Åî„Å®„Å´Áï∞„Å™„Çã„É¨„Éô„É´„ÇíËß£Êîæ
            if (password === 'nenbutsu-mashimashi1') {
                // ‰ªèÊÄßLev2„ÇíËß£ÊîæÔºàeasy„Çí„ÇØ„É™„Ç¢Ê∏à„Åø„Å´„Åô„ÇãÔºâ
                if (!cleared.includes('easy')) {
                    cleared.push('easy');
                }
                localStorage.setItem('nenbunClearedLevels', JSON.stringify(cleared));
                message = '‚úì ‰ªèÊÄßLev2„ÇíËß£Êîæ„Åó„Åæ„Åó„ÅüÔºÅ';
                unlocked = true;
            } else if (password === 'nenbutsu-mashimashi2') {
                // ‰ªèÊÄßLev3„ÇíËß£ÊîæÔºàeasy, normal„Çí„ÇØ„É™„Ç¢Ê∏à„Åø„Å´„Åô„ÇãÔºâ
                if (!cleared.includes('easy')) {
                    cleared.push('easy');
                }
                if (!cleared.includes('normal')) {
                    cleared.push('normal');
                }
                localStorage.setItem('nenbunClearedLevels', JSON.stringify(cleared));
                message = '‚úì ‰ªèÊÄßLev3„ÇíËß£Êîæ„Åó„Åæ„Åó„ÅüÔºÅ';
                unlocked = true;
            } else if (password === 'nenbutsu-mashimashi3') {
                // È¨º„É¨„Éô„É´„ÇíËß£ÊîæÔºàeasy, normal, hard„Çí„ÇØ„É™„Ç¢Ê∏à„Åø„Å´„Åô„ÇãÔºâ
                if (!cleared.includes('easy')) {
                    cleared.push('easy');
                }
                if (!cleared.includes('normal')) {
                    cleared.push('normal');
                }
                if (!cleared.includes('hard')) {
                    cleared.push('hard');
                }
                localStorage.setItem('nenbunClearedLevels', JSON.stringify(cleared));
                message = '‚úì È¨º„É¨„Éô„É´„ÇíËß£Êîæ„Åó„Åæ„Åó„ÅüÔºÅ';
                unlocked = true;
            }

            if (unlocked) {
                passwordMessage.textContent = message;
                passwordMessage.className = 'success';

                setTimeout(() => {
                    passwordModal.classList.add('hidden');
                    showLevelSelect(); // „É¨„Éô„É´ÈÅ∏ÊäûÁîªÈù¢„ÇíÊõ¥Êñ∞
                }, 1500);
            } else {
                passwordMessage.textContent = '‚úó „Éë„Çπ„ÉØ„Éº„Éâ„ÅåÈÅï„ÅÑ„Åæ„Åô';
                passwordMessage.className = 'error';
                passwordInput.value = '';
                passwordInput.focus();
            }
        }

        // ‰ªÆÊÉ≥„Ç≥„É≥„Éà„É≠„Éº„É©„Éº„ÅÆ„Ç§„Éô„É≥„Éà
        // Â∑¶„Éú„Çø„É≥
        leftBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            touchLeft = true;
        });
        leftBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            touchLeft = false;
        });
        leftBtn.addEventListener('mousedown', (e) => {
            e.preventDefault();
            touchLeft = true;
        });
        leftBtn.addEventListener('mouseup', (e) => {
            e.preventDefault();
            touchLeft = false;
        });

        // Âè≥„Éú„Çø„É≥
        rightBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            touchRight = true;
        });
        rightBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            touchRight = false;
        });
        rightBtn.addEventListener('mousedown', (e) => {
            e.preventDefault();
            touchRight = true;
        });
        rightBtn.addEventListener('mouseup', (e) => {
            e.preventDefault();
            touchRight = false;
        });

        // Âøµ‰ªè„Éú„Çø„É≥
        shootBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            if (gameState === 'playing' && canShoot) {
                shootBullet();
                canShoot = false;
                shootCooldown = 10;
            }
        });
        shootBtn.addEventListener('mousedown', (e) => {
            e.preventDefault();
            if (gameState === 'playing' && canShoot) {
                shootBullet();
                canShoot = false;
                shootCooldown = 10;
            }
        });

        // Special attack button
        specialBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            if (kudoku >= maxKudoku) {
                touchSpecial = true;
                activateSpecialAttack();
            }
        });

        specialBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            touchSpecial = false;
        });

        specialBtn.addEventListener('mousedown', (e) => {
            e.preventDefault();
            if (kudoku >= maxKudoku) {
                activateSpecialAttack();
            }
        });

        function clearTitleIntroTimers() {
            titleIntroTimers.forEach(timer => clearTimeout(timer));
            titleIntroTimers = [];
        }

        function queueTitleIntro(callback, delay) {
            const timer = setTimeout(callback, delay);
            titleIntroTimers.push(timer);
        }

        function resetTitleIntroVisualState() {
            titleIntroOverlay.classList.remove('hidden', 'intro-fadeout');
            introMonkHappy.classList.remove('intro-active');
            introMonkSad.classList.remove('intro-active');
            introMonkPray.classList.remove('intro-active');
            titleMainContent.classList.remove('intro-visible');
            titlePersistentPray.classList.remove('visible');
            titlePersistentPray.classList.add('hidden');
        }

        function finishTitleIntro() {
            clearTitleIntroTimers();
            titleIntroRunning = false;
            titleIntroPlayed = true;

            introMonkHappy.classList.add('intro-active');
            introMonkSad.classList.add('intro-active');
            introMonkPray.classList.add('intro-active');
            titlePersistentPray.classList.remove('hidden');
            titlePersistentPray.classList.add('visible');
            titleMainContent.classList.add('intro-visible');
            titleIntroOverlay.classList.add('intro-fadeout');

            queueTitleIntro(() => {
                titleIntroOverlay.classList.add('hidden');
                titleIntroOverlay.classList.remove('intro-fadeout');
            }, 220);
        }

        function skipTitleIntro() {
            if (!titleIntroRunning) return;
            finishTitleIntro();
        }

        function startTitleIntro() {
            clearTitleIntroTimers();
            titleIntroRunning = true;
            resetTitleIntroVisualState();

            queueTitleIntro(() => introMonkHappy.classList.add('intro-active'), 350);
            queueTitleIntro(() => introMonkSad.classList.add('intro-active'), 850);
            queueTitleIntro(() => introMonkPray.classList.add('intro-active'), 1350);
            queueTitleIntro(() => titleMainContent.classList.add('intro-visible'), 1950);
            queueTitleIntro(() => finishTitleIntro(), 2350);
        }

        function showTitle() {
            gameState = 'title';
            titleScreen.classList.remove('hidden');
            levelScreen.classList.add('hidden');
            gameOverScreen.classList.add('hidden');
            rankingScreen.classList.add('hidden');
            infoPanel.classList.add('hidden');
            virtualControls.classList.add('hidden');
            bonnouMessageContainer.innerHTML = ''; // Added: clear bonnou messages

            if (!titleIntroPlayed) {
                startTitleIntro();
            } else {
                clearTitleIntroTimers();
                titleIntroRunning = false;
                titleIntroOverlay.classList.add('hidden');
                titleIntroOverlay.classList.remove('intro-fadeout');
                titlePersistentPray.classList.remove('hidden');
                titlePersistentPray.classList.add('visible');
                titleMainContent.classList.add('intro-visible');
            }
        }

        function showLevelSelect() {
            gameState = 'level';
            titleScreen.classList.add('hidden');
            levelScreen.classList.remove('hidden');
            gameOverScreen.classList.add('hidden');
            rankingScreen.classList.add('hidden');
            bonnouMessageContainer.innerHTML = ''; // Added: clear bonnou messages

            // „É¨„Éô„É´„ÅÆ„É≠„ÉÉ„ÇØÁä∂ÊÖã„ÇíÊõ¥Êñ∞
            const levelEasyBtn = document.getElementById('levelEasy');
            const levelNormalBtn = document.getElementById('levelNormal');
            const levelHardBtn = document.getElementById('levelHard');

            // ‰ªèÊÄßLev1„ÅØÂ∏∏„Å´Ëß£Êîæ
            levelEasyBtn.disabled = false;

            // ‰ªèÊÄßLev2„ÅÆËß£ÊîæÁä∂ÊÖã
            const normalUnlocked = isLevelUnlocked('normal');
            levelNormalBtn.disabled = !normalUnlocked;
            const normalLock = levelNormalBtn.querySelector('.level-lock');
            if (normalLock) {
                normalLock.style.display = normalUnlocked ? 'none' : 'block';
            }

            // ‰ªèÊÄßLev3„ÅÆËß£ÊîæÁä∂ÊÖã
            const hardUnlocked = isLevelUnlocked('hard');
            levelHardBtn.disabled = !hardUnlocked;
            const hardLock = levelHardBtn.querySelector('.level-lock');
            if (hardLock) {
                hardLock.style.display = hardUnlocked ? 'none' : 'block';
            }

            // È¨º„É¨„Éô„É´„ÅÆË°®Á§∫/ÈùûË°®Á§∫
            const demonUnlocked = isLevelUnlocked('demon');
            const levelDemonBtn = document.getElementById('levelDemon');
            if (demonUnlocked) {
                levelDemonBtn.classList.remove('hidden');
            } else {
                levelDemonBtn.classList.add('hidden');
            }
        }

        function showRanking() {
            gameState = 'ranking';
            titleScreen.classList.add('hidden');
            rankingScreen.classList.remove('hidden');
            displayRankings();
        }

        function startGame(level) {
            // Èõ£ÊòìÂ∫¶Ë®≠ÂÆö„ÇíÈÅ©Áî®
            currentLevel = level;
            const settings = levelSettings[level];
            targetScore = settings.targetScore;
            baseSpeed = settings.baseSpeed;
            spawnRate = settings.spawnRate;

            gameState = 'playing';
            score = 0;
            spirit = settings.initialSpirit;
            maxSpirit = settings.initialSpirit;
            kudoku = 0;
            combo = 0;
            maxCombo = 0;
            frame = 0;
            lastBonnou = '';
            heartFlashUntil = 0;
            heartImpactUntil = 0;
            heartPurifyUntil = 0;
            heartStains = [];
            bullets.length = 0;
            enemies.length = 0;
            particles.length = 0;
            player.x = canvas.width / 2;
            touchLeft = false;
            touchRight = false;
            touchSpecial = false;

            titleScreen.classList.add('hidden');
            levelScreen.classList.add('hidden');
            gameOverScreen.classList.add('hidden');
            rankingScreen.classList.add('hidden');
            infoPanel.classList.remove('hidden');
            virtualControls.classList.remove('hidden');

            // ÁÖ©ÊÇ©„É°„ÉÉ„Çª„Éº„Ç∏„Çí„ÇØ„É™„Ç¢
            bonnouMessageContainer.innerHTML = '';


            // BGMÈñãÂßã
            stopSound('gameover');
            stopSound('clear');
            playSound('bgm');

            updateUI();

            // Delta Time setup
            lastTime = performance.now();
            requestAnimationFrame(gameLoop);
        }

        function shootBullet() {
            bullets.push({
                x: player.x,
                y: player.y - 10,
                width: 8,
                height: 20,
                speed: 20, // Doubled from 10
                color: '#d4af37'
            });
            playSound('shoot');
        }

        function spawnEnemy() {
            // 30%„ÅÆÁ¢∫Áéá„ÅßÂÖ≠Ê≥¢ÁæÖËúúÔºàÂ∏ÉÊñΩ„ÉªÊåÅÊàí„ÉªÂøçËæ±„ÉªÁ≤æÈÄ≤„ÉªÁ¶ÖÂÆö„ÉªÊô∫ÊÖßÔºâ„ÅåÂá∫Áèæ
            const isNenbutsu = Math.random() < 0.3;
            const ropparamitsuList = ['Â∏ÉÊñΩ', 'ÊåÅÊàí', 'ÂøçËæ±', 'Á≤æÈÄ≤', 'Á¶ÖÂÆö', 'Êô∫ÊÖß'];
            const bonnou = isNenbutsu ? ropparamitsuList[Math.floor(Math.random() * ropparamitsuList.length)] : bonnouList[Math.floor(Math.random() * bonnouList.length)];
            const settings = levelSettings[currentLevel];
            // „Çπ„Éî„Éº„Éâ = Âü∫Êú¨ÈÄüÂ∫¶ + „É©„É≥„ÉÄ„É† + ÈÄ≤Ë°å„Å´Âøú„Åò„Å¶Âä†ÈÄü
            const speed = baseSpeed + Math.random() * 1.5 + (score * settings.speedIncrease); // Random variance reduced from 3.0

            // ÈáëËâ≤„ÉªÈªÑËâ≤Á≥ªÔºà30-60Â∫¶Ôºâ„ÇíÈÅø„Åë„ÅüËâ≤„ÇíÁîüÊàê
            let hue;
            if (isNenbutsu) {
                hue = null; // ÂÖ≠Ê≥¢ÁæÖËúúÔºàÂ∏ÉÊñΩ„ÉªÊåÅÊàí„ÉªÂøçËæ±„ÉªÁ≤æÈÄ≤„ÉªÁ¶ÖÂÆö„ÉªÊô∫ÊÖßÔºâ„ÅØÂõ∫ÂÆöËâ≤ÔºàÈáëËâ≤Ôºâ
            } else {
                // 0-30Â∫¶ÔºàËµ§ÔΩû„Ç™„É¨„É≥„Ç∏Ôºâ„Åæ„Åü„ÅØ 60-360Â∫¶ÔºàÁ∑ëÔΩûÈùíÔΩûÁ¥´ÔΩûËµ§Ôºâ„Åã„Çâ„É©„É≥„ÉÄ„É†ÈÅ∏Êäû
                const range = Math.random() < 0.2 ? 30 : 300; // 0-30„ÅÆÁØÑÂõ≤„Åå20%„ÄÅ60-360„ÅÆÁØÑÂõ≤„Åå80%
                hue = range === 30 ? Math.random() * 30 : 60 + Math.random() * 300;
            }

            enemies.push({
                x: Math.random() * (canvas.width - 60) + 30,
                y: -50,
                width: 60,
                height: 50,
                speed: speed,
                text: bonnou,
                color: isNenbutsu ? '#FFD700' : `hsl(${hue}, 70%, 50%)`,
                hp: 1,
                isNenbutsu: isNenbutsu
            });
        }

        function createParticles(x, y, color) {
            for (let i = 0; i < 20; i++) {
                particles.push({
                    x: x,
                    y: y,
                    vx: (Math.random() - 0.5) * 16, // Doubled speed
                    vy: (Math.random() - 0.5) * 16, // Doubled speed
                    life: 40,
                    color: color,
                    size: Math.random() * 4 + 2
                });
            }
        }



        function checkCollision(rect1, rect2) {
            return rect1.x < rect2.x + rect2.width &&
                rect1.x + rect1.width > rect2.x &&
                rect1.y < rect2.y + rect2.height &&
                rect1.y + rect1.height > rect2.y;
        }

        function updateUI() {
            const settings = levelSettings[currentLevel];
            document.getElementById('score').textContent = score;
            document.getElementById('targetScore').textContent = settings.isInfinite ? '‚àû' : targetScore;
            document.getElementById('spirit').textContent = spirit;

            const kudokuDisplay = document.getElementById('kudoku');
            kudokuDisplay.textContent = kudoku;
            kudokuDisplay.style.color = kudoku >= maxKudoku ? '#ff0000' : '#fff';

            document.getElementById('combo').textContent = combo;
            document.getElementById('levelDisplay').textContent = settings.name;

            updateSpecialButton();
        }

        function updateSpecialButton() {
            if (kudoku >= maxKudoku) {
                specialBtn.classList.add('ready');
                specialBtn.classList.remove('disabled');
            } else {
                specialBtn.classList.remove('ready');
                specialBtn.classList.add('disabled');
            }
        }

        function activateSpecialAttack() {
            if (kudoku < maxKudoku || gameState !== 'playing') return;

            // Count and clear all enemies with particles
            let defeatedCount = 0;
            enemies.forEach(enemy => {
                createParticles(enemy.x + enemy.width / 2, enemy.y + enemy.height / 2, enemy.color);
                // Only count bonnou (non-nenbutsu enemies) toward score
                if (!enemy.isNenbutsu) {
                    defeatedCount++;
                }
            });
            enemies.splice(0, enemies.length); // Properly clear the array

            // Add defeated enemies to score and combo
            score += defeatedCount;
            combo += defeatedCount;
            if (combo > maxCombo) maxCombo = combo;

            // Reset kudoku
            kudoku = 0;
            updateUI();

            // Play sound effect
            playSound('hit');

            // Visual flash effect
            flashScreen();

            // Check if game is won
            if (score >= targetScore) {
                gameOver(true);
            }
        }

        function flashScreen() {
            const flash = document.createElement('div');
            flash.style.position = 'fixed';
            flash.style.top = '0';
            flash.style.left = '0';
            flash.style.width = '100%';
            flash.style.height = '100%';
            flash.style.backgroundColor = 'rgba(255, 215, 0, 0.8)';
            flash.style.zIndex = '50';
            flash.style.pointerEvents = 'none';
            document.body.appendChild(flash);

            setTimeout(() => {
                flash.style.transition = 'opacity 0.5s';
                flash.style.opacity = '0';
                setTimeout(() => flash.remove(), 500);
            }, 100);
        }

        function shakeScreen() {
            const container = document.getElementById('gameContainer');
            // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„Çí„É™„Çª„ÉÉ„Éà„Åô„Çã„Åü„ÇÅ„Å´„ÇØ„É©„Çπ„Çí‰∏ÄÂ∫¶ÂâäÈô§
            container.classList.remove('shake');
            // „É™„Éï„É≠„Éº„ÇíÂº∑Âà∂
            void container.offsetWidth;
            container.classList.add('shake');

            // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÁµÇ‰∫ÜÂæå„Å´„ÇØ„É©„Çπ„ÇíÂâäÈô§
            setTimeout(() => {
                container.classList.remove('shake');
            }, 500);
        }

        function gameOver(win) {
            gameState = 'gameover';
            gameOverScreen.classList.remove('hidden');
            infoPanel.classList.add('hidden');
            virtualControls.classList.add('hidden');

            // BGMÂÅúÊ≠¢„Å®ÁµêÊûúÈü≥
            stopSound('bgm');
            if (win) {
                playSound('clear');
                // „É¨„Éô„É´„ÇØ„É™„Ç¢ÊôÇ„Å´ÈÄ≤Ë°åÁä∂Ê≥Å„Çí‰øùÂ≠ò
                saveClearedLevel(currentLevel);
            } else {
                playSound('gameover');
                shakeScreen(); // „Ç≤„Éº„É†„Ç™„Éº„Éê„ÉºÊôÇ„ÇÇÊè∫„Çâ„Åô
            }

            // „É©„É≥„Ç≠„É≥„Ç∞‰øùÂ≠ò
            saveRanking(score, maxCombo);

            const settings = levelSettings[currentLevel];
            const targetDisplay = settings.isInfinite ? '‚àû' : targetScore;
            const levelValue = settings.isInfinite ? 'È¨º' : ({
                easy: '1',
                normal: '2',
                hard: '3'
            }[currentLevel] || currentLevel);

            if (win) {
                let titleText = '‰ªèÊÄß„ÅåËÇ≤„Å°„Åæ„Åó„Åü!';
                if (currentLevel === 'hard') {
                    titleText = 'Ëß£ËÑ±ÈÅîÊàê';
                }
                document.getElementById('resultTitle').textContent = titleText;
                document.getElementById('resultText').textContent = `${targetScore}„ÅÆÁÖ©ÊÇ©„ÇíÂÖ®„Å¶Êâì„Å°Êâï„ÅÑ„Åæ„Åó„Åü`;
                document.getElementById('currentScore').innerHTML = `
                    <div class="result-stats-container">
                        <div class="stat-item">
                            <div class="stat-label">‰ªèÊÄßLev</div>
                            <div class="stat-value">${levelValue}</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">ÊíÉÁ†¥Êï∞</div>
                            <div class="stat-value">${score} / ${targetDisplay}</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">ÊúÄÂ§ßÈÄ£Èéñ</div>
                            <div class="stat-value">${maxCombo}</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Áç≤ÂæóÂäüÂæ≥</div>
                            <div class="stat-value">${kudoku}</div>
                        </div>
                    </div>`;
            } else {
                document.getElementById('resultTitle').textContent = 'ÁÖ©ÊÇ©„Å´Âëë„Åæ„Çå„Åü';
                if (settings.isInfinite) {
                    document.getElementById('resultText').textContent = `È¨º„ÅÆÁÖ©ÊÇ©„Å´Âëë„Åæ„Çå„Å¶„Åó„Åæ„ÅÑ„Åæ„Åó„Åü...`;
                } else {
                    document.getElementById('resultText').textContent = `„Äå${lastBonnou}„Äç„Å´ÂøÉ„Çí‰æµ„Åï„Çå„Å¶„Åó„Åæ„ÅÑ„Åæ„Åó„Åü`;
                }
                document.getElementById('currentScore').innerHTML = `
                    <div class="result-stats-container">
                        <div class="stat-item">
                            <div class="stat-label">‰ªèÊÄßLev</div>
                            <div class="stat-value">${levelValue}</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">ÊíÉÁ†¥Êï∞</div>
                            <div class="stat-value">${score} / ${targetDisplay}</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">ÊúÄÂ§ßÈÄ£Èéñ</div>
                            <div class="stat-value">${maxCombo}</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Áç≤ÂæóÂäüÂæ≥</div>
                            <div class="stat-value">${kudoku}</div>
                        </div>
                    </div>`;
            }

            // Set Result Image
            const resultImage = document.getElementById('resultImage');
            if (win) {
                resultImage.src = 'images/monk/monk_happy.png';
            } else {
                resultImage.src = 'images/monk/monk_sad.png';
            }
        }

        // Delta Time Management
        let lastTime = 0;
        let accumulator = 0;
        const TARGET_FPS = 60;
        const STEP = 1000 / TARGET_FPS;

        function update(timeScale) {
            if (gameState !== 'playing') return;

            // „Ç™„Éº„Éà„Éè„Ç§„ÉâÂà§ÂÆöÔºà„Çπ„Éû„ÉõË°®Á§∫„ÅÆÊôÇ„ÅÆ„ÅøÊúâÂäπ„Å´„Åô„Çã„Åã„ÄÅÂ∏∏ÊôÇÂãï„Åã„Åó„Å¶„ÇÇÂÆ≥„ÅØ„Å™„ÅÑ„Åå„ÄÅ„ÇØ„É©„Çπ‰ªò‰∏é„ÅØDOMÊìç‰Ωú„Å™„ÅÆ„ÅßÈ†ªÂ∫¶„Çí‰∏ã„Åí„ÇãÔºâ
            // virtualControls„ÅåË°®Á§∫„Åï„Çå„Å¶„ÅÑ„ÇãÔºàhidden„Åå„Å™„ÅÑÔºâÂ†¥Âêà„ÅÆ„ÅøÂà§ÂÆö
            if (!virtualControls.classList.contains('hidden')) {
                if (Date.now() - lastInputTime > HIDE_DELAY) {
                    if (!virtualControls.classList.contains('inactive')) {
                        virtualControls.classList.add('inactive');
                    }
                }
            }

            frame++;

            // „ÇØ„Éº„É´„ÉÄ„Ç¶„É≥ÁÆ°ÁêÜ (Frame-based to Time-based conversion: 1 unit ~ 1 frame)
            if (shootCooldown > 0) {
                shootCooldown -= 1 * timeScale;
                if (shootCooldown <= 0) {
                    shootCooldown = 0;
                    canShoot = true;
                }
            }

            // „Éó„É¨„Ç§„É§„ÉºÁßªÂãïÔºà„Ç≠„Éº„Éú„Éº„Éâ + ‰ªÆÊÉ≥„Ç≥„É≥„Éà„É≠„Éº„É©„ÉºÔºâ
            if ((keys['ArrowLeft'] || touchLeft) && player.x > player.width / 2) {
                player.x -= player.speed * timeScale;
            }
            if ((keys['ArrowRight'] || touchRight) && player.x < canvas.width - player.width / 2) {
                player.x += player.speed * timeScale;
            }

            // Âºæ„ÅÆÊõ¥Êñ∞
            for (let i = bullets.length - 1; i >= 0; i--) {
                bullets[i].y -= bullets[i].speed * timeScale;
                if (bullets[i].y < -20) {
                    bullets.splice(i, 1);
                }
            }

            // Êïµ„ÅÆÁîüÊàêÔºàÈõ£ÊòìÂ∫¶„Å´Âøú„Åò„ÅüÈñìÈöîÔºâ
            const settings = levelSettings[currentLevel];
            // Adjust spawn calculations for delta time - using frame accumulation
            // Originally based on frames, so we keep logic but spawn checks happen per frame update equivalent
            const currentSpawnRate = Math.max(spawnRate - Math.floor(score / 10), settings.isInfinite ? 10 : 15);

            // Using a separate counter for spawning which scales with time
            if (frame % Math.floor(currentSpawnRate) === 0 && (settings.isInfinite || score < targetScore)) {
                spawnEnemy();
            }



            // Êïµ„ÅÆÊõ¥Êñ∞
            for (let i = enemies.length - 1; i >= 0; i--) {
                enemies[i].y += enemies[i].speed * timeScale;

                // ÁîªÈù¢Â§ñ„Å´Âá∫„Åü„ÇâÂâäÈô§
                if (enemies[i].y > canvas.height) {
                    if (enemies[i].isNenbutsu) {
                        // ÂÖ≠Ê≥¢ÁæÖËúúÔºàÂ∏ÉÊñΩ„ÉªÊåÅÊàí„ÉªÂøçËæ±„ÉªÁ≤æÈÄ≤„ÉªÁ¶ÖÂÆö„ÉªÊô∫ÊÖßÔºâ„ÅØÁîªÈù¢Â§ñ„Å´Âá∫„Å¶„ÇÇOKÔºà„ÇÄ„Åó„ÇçËâØ„ÅÑÔºâ
                        enemies.splice(i, 1);
                    } else {
                        // ÁÖ©ÊÇ©„ÅØÁîªÈù¢Â§ñ„Å´Âá∫„Åü„Çâ„ÉÄ„É°„Éº„Ç∏
                        const breachX = enemies[i].x + enemies[i].width / 2;
                        lastBonnou = enemies[i].text; // „ÇÑ„Çâ„Çå„ÅüÁÖ©ÊÇ©„ÇíË®òÈå≤
                        showBonnouMessage(enemies[i].text); // ÁÖ©ÊÇ©„É°„ÉÉ„Çª„Éº„Ç∏„Çí3ÁßíË°®Á§∫
                        enemies.splice(i, 1);
                        spirit--;
                        triggerHeartBreach(breachX);
                        combo = 0;
                        playSound('damage');
                        shakeScreen(); // „ÉÄ„É°„Éº„Ç∏ÊôÇ„Å´ÁîªÈù¢„ÇíÊè∫„Çâ„Åô
                        updateUI();
                        if (spirit <= 0) {
                            gameOver(false);
                        }
                    }
                    continue;
                }

                // „Éó„É¨„Ç§„É§„Éº„Å®„ÅÆË°ùÁ™ÅÂà§ÂÆöÔºàÂÖ≠Ê≥¢ÁæÖËúú„Å´Ëß¶„Çå„Åü„ÇâHPÂõûÂæ©Ôºâ
                const playerRect = {
                    x: player.x - player.width / 2,
                    y: player.y - 30,
                    width: player.width,
                    height: 50
                };
                if (enemies[i].isNenbutsu && checkCollision(enemies[i], playerRect)) {
                    createParticles(enemies[i].x + enemies[i].width / 2,
                        enemies[i].y + enemies[i].height / 2,
                        enemies[i].color);
                    enemies.splice(i, 1);
                    kudoku = Math.min(kudoku + 1, maxKudoku);
                    triggerHeartPurify();
                    updateUI();
                    playSound('hit_bounas');


                    continue;
                }

                // Âºæ„Å®„ÅÆË°ùÁ™ÅÂà§ÂÆö
                for (let j = bullets.length - 1; j >= 0; j--) {
                    if (checkCollision(bullets[j], enemies[i])) {
                        createParticles(enemies[i].x + enemies[i].width / 2,
                            enemies[i].y + enemies[i].height / 2,
                            enemies[i].color);
                        bullets.splice(j, 1);

                        if (enemies[i].isNenbutsu) {
                            // ÂÖ≠Ê≥¢ÁæÖËúú„ÇíÊíÉ„Å£„ÅüÔºàHP„ÅØÊ∏õ„Çâ„Å™„ÅÑÔºâ
                            enemies.splice(i, 1);
                        } else {
                            // ÁÖ©ÊÇ©„ÇíÊíÉÁ†¥
                            enemies.splice(i, 1);
                            score++;
                            combo++;
                            if (combo > maxCombo) maxCombo = combo;
                            playSound('hit');
                            updateUI();

                            if (score >= targetScore) {
                                gameOver(true);
                            }
                        }
                        break;
                    }
                }
            }

            // „Éë„Éº„ÉÜ„Ç£„ÇØ„É´„ÅÆÊõ¥Êñ∞
            for (let i = particles.length - 1; i >= 0; i--) {
                particles[i].x += particles[i].vx * timeScale;
                particles[i].y += particles[i].vy * timeScale;
                particles[i].vy += 0.2 * timeScale;
                particles[i].life -= 1 * timeScale;

                if (particles[i].life <= 0) {
                    particles.splice(i, 1);
                }
            }
        }

        function draw(timestamp) {
            const now = timestamp || performance.now();

            // ËÉåÊôØ„Çí„ÇØ„É™„Ç¢
            ctx.fillStyle = 'rgba(15, 12, 41, 0.2)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // ËÉåÊôØ„ÅÆÊòü
            if (frame % 5 === 0) {
                ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
                for (let i = 0; i < 2; i++) {
                    const x = Math.random() * canvas.width;
                    const y = Math.random() * canvas.height;
                    ctx.fillRect(x, y, 2, 2);
                }
            }

            // „Éó„É¨„Ç§„É§„ÉºÔºà‰øÆË°åÂÉßÔºâ„ÅÆÊèèÁîª
            ctx.save();
            ctx.translate(player.x, player.y);

            if (monkImage.complete && monkImage.naturalWidth !== 0) {
                // ÁîªÂÉè„ÇíÊèèÁîªÔºà‰∏≠ÂøÉ„Å´Âêà„Çè„Åõ„Å¶Ë™øÊï¥Ôºâ
                // Â∞ë„ÅóÂ§ß„Åç„Åè„Åó„ÄÅË°®Á§∫‰ΩçÁΩÆ„Çí‰∏ã„Åí„ÇãÔºà‰∏ã„Å´„ÅØ„ÅøÂá∫„ÅóË®±ÂÆπÔºâ
                const imgSize = 108;
                const yOffset = 6;
                ctx.drawImage(monkImage, -imgSize / 2, -imgSize / 2 + yOffset, imgSize, imgSize);
            } else {
                // ÁîªÂÉèË™≠„ÅøËæº„ÅøÂâç„ÅÆ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºàÂÖÉ„ÅÆÊèèÁîª„É≠„Ç∏„ÉÉ„ÇØÔºâ
                // ‰ΩìÔºàË¢àË£üÔºâ
                ctx.fillStyle = '#ff6f00';
                ctx.fillRect(-player.width / 2, -10, player.width, 30);

                // È†≠
                ctx.fillStyle = '#ffb74d';
                ctx.beginPath();
                ctx.arc(0, -20, 15, 0, Math.PI * 2);
                ctx.fill();

                // ÂêàÊéå
                ctx.fillStyle = '#ffe0b2';
                ctx.fillRect(-5, 0, 10, 15);

                // ÂÖâËÉå
                ctx.strokeStyle = 'rgba(212, 175, 55, 0.3)';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.arc(0, -10, 30, 0, Math.PI * 2);
                ctx.stroke();
            }

            ctx.restore();

            // ÂºæÔºàÂøµ‰ªèÔºâ„ÅÆÊèèÁîª
            bullets.forEach(bullet => {
                ctx.save();
                ctx.fillStyle = bullet.color;
                ctx.shadowBlur = 15;
                ctx.shadowColor = bullet.color;

                // ÂÖâ„ÇãÂºæ
                ctx.beginPath();
                ctx.ellipse(bullet.x, bullet.y, bullet.width / 2, bullet.height / 2, 0, 0, Math.PI * 2);
                ctx.fill();

                // Âçç„Éû„Éº„ÇØ
                ctx.shadowBlur = 0;
                ctx.fillStyle = '#fff';
                ctx.font = 'bold 14px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('Âçç', bullet.x, bullet.y + 5);

                ctx.restore();
            });

            // ÊïµÔºàÁÖ©ÊÇ©Ôºâ„ÅÆÊèèÁîª
            enemies.forEach(enemy => {
                ctx.save();
                ctx.fillStyle = enemy.color;
                ctx.shadowBlur = 20;
                ctx.shadowColor = enemy.color;

                // ÁÖ©ÊÇ©„ÅÆÂΩ¢
                ctx.beginPath();
                if (enemy.isNenbutsu) {
                    // ÂÖ≠Ê≥¢ÁæÖËúú„ÅØ‰∏∏ÔºàÊ•ïÂÜÜÔºâ„ÅÆ„Åæ„Åæ
                    ctx.ellipse(enemy.x + enemy.width / 2, enemy.y + enemy.height / 2,
                        enemy.width / 2, enemy.height / 2, 0, 0, Math.PI * 2);
                } else {
                    // ÁÖ©ÊÇ©„ÅØÈÄÜ‰∏âËßíÔºàüîΩÔºâ
                    ctx.moveTo(enemy.x, enemy.y);
                    ctx.lineTo(enemy.x + enemy.width, enemy.y);
                    ctx.lineTo(enemy.x + enemy.width / 2, enemy.y + enemy.height);
                    ctx.closePath();
                }
                ctx.fill();

                ctx.shadowBlur = 0;

                // „ÉÜ„Ç≠„Çπ„Éà
                ctx.fillStyle = '#fff';
                ctx.font = 'bold 16px sans-serif';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(enemy.text, enemy.x + enemy.width / 2, enemy.y + enemy.height / 2);

                ctx.restore();
            });



            // „Éë„Éº„ÉÜ„Ç£„ÇØ„É´„ÅÆÊèèÁîª
            particles.forEach(particle => {
                ctx.fillStyle = particle.color;
                ctx.globalAlpha = particle.life / 40;
                ctx.beginPath();
                ctx.arc(particle.x, particle.y, particle.size, 0, Math.PI * 2);
                ctx.fill();
                ctx.globalAlpha = 1;
            });

            // „ÄåÂøÉ„Äç„ÇíÁ§∫„Åô„Éú„Éà„É†Â¢ÉÁïåÁ∑öÔºàÁÖ©ÊÇ©„Çà„ÇäÂâçÈù¢Ôºâ
            ctx.save();
            const safeMaxSpirit = Math.max(1, maxSpirit);
            const spiritRatio = Math.max(0, spirit) / safeMaxSpirit;
            const heartbeat = (Math.sin(now * 0.012) + 1) / 2;
            let barRGB = '255, 105, 180';  // ÂÆâÂÆö: „Éî„É≥„ÇØ
            let glowRGB = '255, 105, 180';
            if (spiritRatio <= 0.34) {
                barRGB = '255, 59, 92';    // ÁÄïÊ≠ª: Ëµ§
                glowRGB = '255, 45, 85';
            } else if (spiritRatio <= 0.67) {
                barRGB = '211, 70, 154';   // Âç±Èô∫: Ëµ§Á¥´
                glowRGB = '214, 51, 132';
            }

            let barHeight = 12 + Math.round(heartbeat * 4);
            if (now < heartImpactUntil) {
                const impactProgress = (heartImpactUntil - now) / 260;
                barHeight += Math.ceil(8 * Math.max(0, impactProgress));
            }

            const flashActive = now < heartFlashUntil && Math.floor((heartFlashUntil - now) / 60) % 2 === 0;
            let barAlpha = 0.78 + heartbeat * 0.18;
            let glowAlpha = 0.88 + heartbeat * 0.12;
            let glowBlur = 10 + heartbeat * 8;
            if (flashActive) {
                barRGB = '255, 209, 234';
                glowRGB = '255, 143, 200';
                barAlpha = 0.96;
                glowAlpha = 1.0;
                glowBlur = 16;
            }

            ctx.fillStyle = `rgba(${barRGB}, ${barAlpha.toFixed(3)})`;
            ctx.shadowBlur = glowBlur;
            ctx.shadowColor = `rgba(${glowRGB}, ${glowAlpha.toFixed(3)})`;
            ctx.fillRect(0, canvas.height - barHeight, canvas.width, barHeight);
            ctx.shadowBlur = 0;

            // „Éê„ÉºÂÖ®‰Ωì„ÅÆËÑàÂãï„Éè„Ç§„É©„Ç§„ÉàÔºàÊ®™„ÅÑ„Å£„Å±„ÅÑÔºâ
            const highlightHeight = Math.max(2, Math.round(barHeight * 0.35));
            ctx.fillStyle = `rgba(255, 235, 246, ${(0.12 + heartbeat * 0.16).toFixed(3)})`;
            ctx.fillRect(0, canvas.height - barHeight, canvas.width, highlightHeight);

            // ‰æµÂÖ•ÁóïÔºàÈªí„ÅÑÊüì„ÅøÔºâ
            const activeStains = [];
            for (const stain of heartStains) {
                const age = now - stain.createdAt;
                if (age >= stain.duration) continue;
                activeStains.push(stain);

                const life = 1 - age / stain.duration;
                const alpha = stain.maxAlpha * life;
                const centerY = canvas.height - barHeight / 2;

                ctx.fillStyle = `rgba(40, 0, 30, ${alpha.toFixed(3)})`;
                ctx.beginPath();
                ctx.ellipse(stain.x, centerY, stain.width / 2, Math.max(5, barHeight * 0.95), 0, 0, Math.PI * 2);
                ctx.fill();

                ctx.fillStyle = `rgba(15, 0, 12, ${(alpha * 0.8).toFixed(3)})`;
                ctx.beginPath();
                ctx.ellipse(stain.x, centerY, stain.width * 0.28, Math.max(3, barHeight * 0.6), 0, 0, Math.PI * 2);
                ctx.fill();
            }
            heartStains = activeStains;

            // ÂÖ≠Ê≥¢ÁæÖËúúÂèñÂæóÊôÇ„ÅÆÊµÑÂåñ„É©„Ç§„É≥ÔºàÂÖ®ÂπÖÔºâ
            const purifying = now < heartPurifyUntil;
            if (purifying) {
                const purifyHeight = 4 + Math.round(heartbeat * 2);
                ctx.fillStyle = 'rgba(255, 240, 188, 0.62)';
                ctx.fillRect(0, canvas.height - barHeight - purifyHeight, canvas.width, purifyHeight);
            }
            ctx.restore();

            // „Ç≥„É≥„ÉúË°®Á§∫
            if (combo > 2) {
                ctx.save();
                ctx.fillStyle = '#ffd700';
                ctx.font = 'bold 32px sans-serif';
                ctx.textAlign = 'center';
                ctx.shadowBlur = 15;
                ctx.shadowColor = '#ffd700';
                ctx.fillText(`√ó${combo} COMBO!`, canvas.width / 2, 50);
                ctx.restore();
            }
        }

        function gameLoop(timestamp) {
            if (gameState !== 'playing') return;

            // Calculate delta time
            const deltaTime = timestamp - lastTime;
            lastTime = timestamp;

            // Calculate scale based on target 60 FPS
            // If delta is 16.6ms (60fps), scale is 1
            // If delta is 33.3ms (30fps), scale is 2
            // If delta is 8.3ms (120fps), scale is 0.5
            let timeScale = deltaTime / STEP;

            // Cap to avoid huge jumps on lags
            if (timeScale > 4) timeScale = 4;

            update(timeScale);
            draw(timestamp);

            requestAnimationFrame(gameLoop);
        }

        // „Éê„Éº„Ç∏„Éß„É≥Ë°®Á§∫
        const version = document.querySelector('meta[name="version"]').content;
        document.getElementById('version-display').textContent = `v${version}`;

        // Initialize Settings
        const settingsModal = document.getElementById('settingsModal');
        const settingsSubmitBtn = document.getElementById('settingsSubmitBtn');
        // const openSettingsBtn = document.getElementById('openSettingsBtn'); // Replaced by Menu
        const menuBtn = document.getElementById('menuBtn');
        const menuModal = document.getElementById('menuModal');
        // const tutorialBtn = document.getElementById('tutorialBtn'); // Replaced by Menu inside modal

        const closeMenuBtn = document.getElementById('closeMenuBtn');
        const menuSettingsBtn = document.getElementById('menuSettingsBtn');
        const menuTosBtn = document.getElementById('menuTosBtn');
        const menuTutorialBtn = document.getElementById('menuTutorialBtn');


        const toggleBtns = document.querySelectorAll('.toggle-btn');

        // Default temporary settings for the modal
        let tempSettings = {
            sound: 'on',
            mode: 'pc'
        };

        function loadTempSettingsFromStorage() {
            const savedSettings = localStorage.getItem('nenbunSettings');
            if (savedSettings) {
                tempSettings = JSON.parse(savedSettings);
            } else {
                // Defaults
                tempSettings = {
                    sound: 'on',
                    mode: 'pc'
                };
            }
        }

        function initSettings() {
            const savedSettings = localStorage.getItem('nenbunSettings');

            if (!savedSettings) {
                // No settings saved, show modal
                loadTempSettingsFromStorage(); // Load defaults
                settingsModal.classList.remove('hidden');
                updateToggleButtons();
            } else {
                // Settings exist, apply them
                const settings = JSON.parse(savedSettings);
                applySettings(settings);
                showTitle();
            }
        }

        function applySettings(settings) {
            // Apply Mode
            if (settings.mode === 'mobile') {
                document.body.classList.add('mobile-mode');
            } else {
                document.body.classList.remove('mobile-mode');
            }

            // Apply Sound (Set volume globally)
            if (settings.sound === 'off') {
                Object.values(sounds).forEach(audio => {
                    audio.volume = 0;
                });
                // Disable unlockAudio if sound is off
                document.removeEventListener('touchstart', unlockAudio);
                document.removeEventListener('click', unlockAudio);
                document.removeEventListener('keydown', unlockAudio);
            } else {
                // Restore default volumes if needed (re-run init logic or just set specific volumes)
                // For simplicity, we just leave them as initialized or unlocked
                // If we implemented a mute toggle during gameplay, we'd need more robust volume management
                sounds.bgm.volume = 0.5;
                sounds.shoot.volume = 0.3;
                sounds.hit.volume = 0.4;
                sounds.damage.volume = 0.5;
                sounds.gameover.volume = 0.6;
                sounds.clear.volume = 0.6;
            }
        }

        function updateToggleButtons() {
            toggleBtns.forEach(btn => {
                const group = btn.dataset.group;
                const value = btn.dataset.value;
                if (tempSettings[group] === value) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        // Event Listeners for Settings Modal
        toggleBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const group = btn.dataset.group;
                const value = btn.dataset.value;
                tempSettings[group] = value;
                updateToggleButtons();
            });
        });

        settingsSubmitBtn.addEventListener('click', () => {
            // Save settings
            localStorage.setItem('nenbunSettings', JSON.stringify(tempSettings));

            // Apply settings
            applySettings(tempSettings);

            // Hide settings modal
            settingsModal.classList.add('hidden');

            // Check if ToS AGREED
            const tosAgreed = localStorage.getItem('nenbunTosAgreed');
            if (!tosAgreed) {
                // Determine flow: Settings -> ToS -> Tutorial -> Title
                tosModal.classList.remove('hidden');
            } else {
                if (gameState === 'title') {
                    showTitle();
                }
            }

            // Attempt to unlock audio immediately if sound is ON (since user clicked a button)
            if (tempSettings.sound === 'on') {
                unlockAudio();
            }
        });

        // Menu Interactions
        menuBtn.addEventListener('click', () => {
            // playSound('select');
            menuModal.classList.remove('hidden');
        });

        closeMenuBtn.addEventListener('click', () => {
            menuModal.classList.add('hidden');
        });

        menuSettingsBtn.addEventListener('click', () => {
            menuModal.classList.add('hidden');
            loadTempSettingsFromStorage();
            updateToggleButtons();
            settingsModal.classList.remove('hidden');
        });

        menuTosBtn.addEventListener('click', () => {
            menuModal.classList.add('hidden');
            tosModal.classList.remove('hidden');
        });

        menuTutorialBtn.addEventListener('click', () => {
            menuModal.classList.add('hidden');
            openTutorial();
        });



        // Initialize
        // showTitle(); // Removed direct call, moved to initSettings
        initSettings();

        // Title Screen Tutorial Button Removed - Now accessed via Menu
        /*
        tutorialBtn.addEventListener('click', () => {
            openTutorial();
        });
        */

        // ToS Logic
        tosAgreeBtn.addEventListener('click', () => {
            localStorage.setItem('nenbunTosAgreed', 'true');
            tosModal.classList.add('hidden');

            // Removed automatic tutorial open
            // openTutorial();

            if (gameState === 'title') {
                showTitle();
            }
        });

        // Tutorial Logic
        function openTutorial() {
            currentSlide = 0;
            updateSlides();
            tutorialModal.classList.remove('hidden');
        }

        function updateSlides() {
            slides.forEach((slide, index) => {
                if (index === currentSlide) {
                    slide.style.display = 'flex'; // Changed to flex for centering
                    slide.classList.add('active');
                } else {
                    slide.style.display = 'none';
                    slide.classList.remove('active');
                }
            });

            dots.forEach((dot, index) => {
                if (index === currentSlide) dot.classList.add('active');
                else dot.classList.remove('active');
            });

            prevSlideBtn.disabled = currentSlide === 0;
            prevSlideBtn.style.opacity = currentSlide === 0 ? 0.3 : 1;

            if (currentSlide === slides.length - 1) {
                nextSlideBtn.textContent = 'Èñâ„Åò„Çã';
            } else {
                nextSlideBtn.textContent = 'Ê¨°„Å∏';
            }
        }

        prevSlideBtn.addEventListener('click', () => {
            if (currentSlide > 0) {
                currentSlide--;
                updateSlides();
            }
        });

        nextSlideBtn.addEventListener('click', () => {
            if (currentSlide < slides.length - 1) {
                currentSlide++;
                updateSlides();
            } else {
                // Close tutorial
                tutorialModal.classList.add('hidden');
                // Ensure audio is unlocked if just starting
                if (tempSettings.sound === 'on') unlockAudio();

                showTitle();
            }
        });

        function setSlide(index) {
            currentSlide = index;
            updateSlides();
        }

    </script>
</body>

</html>
